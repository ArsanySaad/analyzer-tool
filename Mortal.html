<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analyzer Tool - Mail, Broker & Lottery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .summary-btn, .ai-btn, .process-btn {
             min-width: 120px;
             margin-top: 0.5rem; 
        }

        .hidden { display: none !important; } 
        .loading-dots span {
            animation: blink 1.4s infinite both;
            display: inline-block;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        .file-input-hidden {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        #fileNameDisplay {
            margin-left: 0.75rem; 
            font-style: italic;
            color: #4a5568; 
            min-height: 1.25rem; 
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #e2e8f0; 
        }
        .sort-indicator {
            font-size: 0.7em; 
            margin-left: 4px;
            display: inline-block;
            width: 1em; 
        }
        .anomaly-yes {
            color: #e53e3e; /* Tailwind red-600 */
            font-weight: bold;
        }
        .metrics-value {
            font-weight: 600;
        }
        .positive-net { color: #38a169; /* Tailwind green-600 */ }
        .negative-net { color: #e53e3e; /* Tailwind red-600 */ }
        .chart-container {
            width: 100%;
            height: 340px; /* Increased height for labels */
        }
        .chat-display {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .chat-message {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .chat-message-user {
            background-color: #dbeafe; /* Tailwind blue-100 */
            text-align: right;
        }
        .chat-message-ai {
            background-color: #f3e8ff; /* Tailwind purple-100 for Mail/Broker */
        }
        .chat-message-ai-lottery { /* Specific for lottery AI */
             background-color: #f0fdfa; /* Tailwind teal-50 */
        }
        .chat-input-area {
            display: flex;
            gap: 0.5rem;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
        }
        /* Styles for scrollable and collapsible tables */
        .table-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            /* No transition on the container itself for smoother drag-resizing */
        }
        .toggle-btn.collapsed svg {
            transform: rotate(-90deg);
        }
        .toggle-btn svg {
            transition: transform 0.2s ease-in-out;
        }
        .resize-handle {
            width: 100%;
            height: 5px; 
            background-color: transparent; /* Invisible by default */
            cursor: ns-resize;
            border-radius: 3px;
            margin-top: 2px; 
            transition: background-color 0.2s ease-in-out, height 0.2s ease-in-out;
        }
        .resize-handle:hover {
            background-color: #4f46e5; /* A vibrant color for hover state */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">Log Analyzer Tool (Mail, Broker & Lottery)</h1>
        </header>

        <section class="bg-white p-6 rounded-xl shadow-xl mb-8">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">1. Select Log File:</h2>
            <div class="flex items-center mb-4">
                <input type="file" id="logFileInput" accept=".csv,.json,.txt" class="file-input-hidden"/>
                <label for="logFileInput" class="inline-block bg-gray-600 hover:bg-gray-800 active:bg-gray-900 text-white rounded-md py-2 px-4 outline-none whitespace-nowrap cursor-pointer font-semibold text-sm transition-colors duration-200 ease-in-out">Choose Log File</label>
                <span id="fileNameDisplay" class="ml-3 text-sm text-gray-600"></span>
            </div>
            
            <div class="mt-2 flex flex-col sm:flex-row flex-wrap gap-3"> 
                <button id="processMailBrokerButton" class="process-btn bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out w-full sm:w-auto">Process Mail/Broker Logs</button>
                <button id="processLotteryButton" class="process-btn bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out w-full sm:w-auto">Process Lottery Logs</button>
            </div>
        </section>

        <div id="feedbackArea" class="-mt-6 mb-6 text-center text-sm text-gray-600 min-h-[1.25rem]"></div>

        
        <section id="skippedLogsContainer" class="bg-white p-6 rounded-xl shadow-xl mb-8 hidden">
             <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl sm:text-2xl font-semibold text-yellow-700">Skipped Log Entries</h3>
                <button id="toggleSkippedLogsBtn" title="Toggle Skipped Logs Visibility" class="toggle-btn collapsed p-1 rounded-md hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
            <div id="skippedLogsContent" class="hidden">
                <div class="table-scroll-container bg-gray-50 border border-gray-200 rounded-lg p-4 font-mono text-xs">
                    <ul id="skippedLogsList"></ul>
                </div>
                <div id="skippedLogsResizeHandle" class="resize-handle"></div>
            </div>
        </section>

        <section id="reportArea" class="bg-white p-6 rounded-xl shadow-xl hidden">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">2. Analysis Report</h2>
                <div id="dateFilterContainer" class="flex flex-col md:flex-row gap-4 hidden items-end">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date:</label>
                        <input type="date" id="startDate" name="startDate" class="mt-1 block w-full md:w-auto border border-gray-300 rounded-md p-2">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">End Date:</label>
                        <input type="date" id="endDate" name="endDate" class="mt-1 block w-full md:w-auto border border-gray-300 rounded-md p-2">
                    </div>
                    <button id="clearDateFilterButton" class="bg-gray-600 hover:bg-gray-800 text-white font-semibold py-2 px-3 rounded-md text-sm self-end">Clear Filter</button>
                </div>
            </div>
             <div id="activeFilterInfo" class="mb-4 p-3 bg-blue-50 text-blue-700 rounded-md hidden">
                Filtering by date: <span id="filterDateRange"></span>
            </div>


            
            <div id="mailTableContainer" class="mb-10 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl sm:text-2xl font-semibold text-gray-600">Aggregated Mail Transactions</h3>
                    <button id="toggleMailTableBtn" title="Toggle Table Visibility" class="toggle-btn p-1 rounded-md hover:bg-gray-200 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="mailTableContent">
                    <div class="overflow-x-auto rounded-lg shadow table-scroll-container">
                        <table id="mailTransactionsTable" class="min-w-full w-full bg-white border border-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr class="text-sm font-semibold text-gray-600">
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="mail" data-sort-by="displayLogType">Type <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="mail" data-sort-by="sender">Sender <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="mail" data-sort-by="receiver">Receiver <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-center" data-table-type="mail" data-sort-by="times">Times <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="mail" data-sort-by="itemName">Item Name <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="mail" data-sort-by="totalQuantity">Quantity <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="mail" data-sort-by="totalPrice">Price <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                    <p id="noMailTransactionsMessage" class="text-gray-500 mt-3 hidden">No mail transactions found.</p>
                    <div id="mailResizeHandle" class="resize-handle"></div>
                </div>
            </div>

            
            <div id="brokerTableContainer" class="mb-10 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl sm:text-2xl font-semibold text-gray-600">Aggregated Broker Transactions</h3>
                    <button id="toggleBrokerTableBtn" title="Toggle Table Visibility" class="toggle-btn p-1 rounded-md hover:bg-gray-200 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="brokerTableContent">
                    <div class="overflow-x-auto rounded-lg shadow table-scroll-container">
                        <table id="brokerTransactionsTable" class="min-w-full w-full bg-white border border-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr class="text-sm font-semibold text-gray-600">
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="broker" data-sort-by="displayLogType">Type <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="broker" data-sort-by="sender">Seller <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="broker" data-sort-by="receiver">Buyer <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-center" data-table-type="broker" data-sort-by="times">Times <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="broker" data-sort-by="itemName">Item Name <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="broker" data-sort-by="totalQuantity">Quantity <span class="sort-indicator"></span></th>
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="broker" data-sort-by="orderFillAmount">Amount <span class="sort-indicator"></span></th> 
                                    <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="broker" data-sort-by="totalPrice">Price <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                    <p id="noBrokerTransactionsMessage" class="text-gray-500 mt-3 hidden">No broker transactions found.</p>
                    <div id="brokerResizeHandle" class="resize-handle"></div>
                </div>
            </div>

            
            <div id="lotteryAnalysisSection" class="hidden">
                <h3 class="text-2xl font-semibold text-teal-700 mb-4">Lottery Analysis</h3>
                
                <div id="lotterySummaryMetricsContainer" class="mb-10 p-4 bg-indigo-50 rounded-lg shadow">
                     <h4 class="text-lg font-semibold text-indigo-700 mb-3">Lottery Metrics Summary</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                        <p>Total Tickets Used: <span id="lotteryTotalTickets" class="metrics-value">0</span></p>
                        <p>Total Gold Spent (at 3 gold/ticket): <span id="lotteryGoldIn" class="metrics-value">0</span></p>
                        <p>Total Winning Tickets (incl. anomalies with payout): <span id="lotteryTotalWinningTickets" class="metrics-value">0</span></p>
                        <p>Total Gold Won from System: <span id="lotteryGoldOut" class="metrics-value">0</span></p>
                        <p>Net Gold Impact (Won - Spent): <span id="lotteryNetGold" class="metrics-value">0</span></p>
                        <p>Overall Win Rate (% of tickets that paid): <span id="lotteryWinRate" class="metrics-value">0%</span></p>
                        <p>Return To Player (RTP %): <span id="lotteryRTP" class="metrics-value">0%</span></p>
                        <p>Anomalous Win Entries: <span id="lotteryAnomalyCount" class="metrics-value">0</span></p>
                     </div>
                </div>

                <div id="lotteryAnomaliesContainer" class="mb-6 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-red-800">Detected Anomalies (<span id="anomalyCount">0</span>)</h4>
                        <button id="toggleAnomaliesBtn" title="Toggle Anomalies Visibility" class="toggle-btn p-1 rounded-md hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="anomaliesContent">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-xs text-gray-600 mb-2">Anomalies are always based on the full, unfiltered dataset.</p>
                            <div class="table-scroll-container">
                                <ul id="lotteryAnomaliesList" class="list-disc pl-5 space-y-1 text-sm"></ul>
                            </div>
                        </div>
                        <div id="anomaliesResizeHandle" class="resize-handle"></div>
                    </div>
                </div>

                
                <div id="lotteryFilterContainer" class="bg-gray-50 rounded-lg shadow-inner p-4 my-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Filter Win Types</h4>
                    <p class="text-xs text-gray-600 mb-3">Filters apply to Metrics and Charts, but not the aggregated results table below.</p>
                    <div id="lotteryWinTypeFilters" class="flex flex-wrap gap-x-6 gap-y-2">
                        
                    </div>
                </div>

                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Win Type Distribution</h4>
                        <div id="lotteryWinTypePieChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Hourly Lottery Activity</h4>
                        <div id="lotteryHourlyChart" class="chart-container"></div>
                    </div>
                </div>
                
                <div id="lotteryAggregatedResultsContainer" class="mb-10"> 
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl sm:text-2xl font-semibold text-gray-600">Aggregated Lottery Results (by Player)</h3>
                        <button id="toggleLotteryTableBtn" title="Toggle Table Visibility" class="toggle-btn p-1 rounded-md hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="lotteryTableContent">
                        <div class="overflow-x-auto rounded-lg shadow table-scroll-container">
                            <table id="lotteryResultsTable" class="min-w-full w-full bg-white border border-gray-200">
                                <thead class="bg-gray-100 sticky top-0 z-10">
                                    <tr class="text-sm font-semibold text-gray-600">
                                        <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="lottery" data-sort-by="playerName">Player <span class="sort-indicator"></span></th>
                                        <th class="py-3 px-4 border-b border-gray-200 sortable-header text-left" data-table-type="lottery" data-sort-by="winTypeDisplay">Win Type <span class="sort-indicator"></span></th>
                                        <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="lottery" data-sort-by="ticketsRolled">Tickets Rolled <span class="sort-indicator"></span></th>
                                        <th class="py-3 px-4 border-b border-gray-200 sortable-header text-right" data-table-type="lottery" data-sort-by="totalGoldWon">Total Gold Won <span class="sort-indicator"></span></th>
                                        <th class="py-3 px-4 border-b border-gray-200 sortable-header text-center" data-table-type="lottery" data-sort-by="isAnomaly">Anomaly <span class="sort-indicator"></span></th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-700 text-sm"></tbody>
                            </table>
                        </div>
                        <p id="noLotteryResultsMessage" class="text-gray-500 mt-3 hidden">No lottery results found in this aggregation.</p>
                        <div id="lotteryResizeHandle" class="resize-handle"></div>
                    </div>
                </div>

                 <div id="lotteryDetailedWinStatsContainer" class="mb-6"> 
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-gray-800">Detailed Win Statistics (by Win Type)</h4>
                        <button id="toggleDetailedStatsBtn" title="Toggle Table Visibility" class="toggle-btn p-1 rounded-md hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="detailedStatsContent">
                        <div class="overflow-x-auto rounded-lg shadow table-scroll-container">
                            <table id="lotteryDetailedStatsTable" class="min-w-full divide-y divide-gray-200"> 
                                <thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-medium sortable-header" data-table-type="lottery-stats" data-sort-by="name">Win Type <span class="sort-indicator"></span></th>
                                        <th class="px-6 py-3 text-right font-medium sortable-header" data-table-type="lottery-stats" data-sort-by="count">Count <span class="sort-indicator"></span></th>
                                        <th class="px-6 py-3 text-right font-medium sortable-header" data-table-type="lottery-stats" data-sort-by="totalPayout">Total Payout <span class="sort-indicator"></span></th>
                                        <th class="px-6 py-3 text-right font-medium sortable-header" data-table-type="lottery-stats" data-sort-by="avgPayout">Avg Payout <span class="sort-indicator"></span></th>
                                        <th class="px-6 py-3 text-right font-medium sortable-header" data-table-type="lottery-stats" data-sort-by="percentOfTickets">% of Tickets <span class="sort-indicator"></span></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 text-sm"></tbody> 
                            </table>
                        </div>
                        <div id="detailedStatsResizeHandle" class="resize-handle"></div>
                    </div>
                </div>
                
                <div id="aiLotteryNarrativeArea" class="bg-white p-6 rounded-xl shadow-xl mt-6 hidden">
                     <h3 class="text-xl sm:text-2xl font-semibold text-green-700 mb-3">AI Generated Lottery Narrative</h3>
                     <div id="aiLotteryNarrativeContent" class="text-gray-700 prose max-w-none whitespace-pre-wrap"></div>
                     <div id="aiLotteryNarrativeLoading" class="text-green-600 hidden flex items-center">
                         <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                         </svg>
                         Generating narrative...
                     </div>
                     <div id="aiLotteryNarrativeError" class="text-red-600 mt-2 hidden"></div>
                      
                    <div id="lotteryChatContainer" class="mt-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Chat about Lottery Data:</h4>
                        <div id="aiChatDisplayLottery" class="chat-display"></div>
                        <div class="chat-input-area">
                            <input type="text" id="aiChatInputLottery" placeholder="Ask about players or win types..." class="p-2">
                            <button id="aiChatSendButtonLottery" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">Send</button>
                        </div>
                        <div id="aiChatLoadingLottery" class="text-teal-600 hidden mt-2">Typing...</div>
                    </div>
                </div>

            </div> 
            
            <div id="summaryControls" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-sm hidden">
                <h3 class="text-xl sm:text-2xl font-semibold text-gray-600 mb-4">Individual Stats Summary (Mail & Broker)</h3>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-3 mb-4">
                    <button data-type="topSenders" class="summary-btn bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all">Top Senders</button>
                    <button data-type="lowestSenders" class="summary-btn bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all">Lowest Senders</button>
                    <button data-type="topReceivers" class="summary-btn bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all">Top Receivers</button>
                    <button data-type="lowestReceivers" class="summary-btn bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all">Lowest Receivers</button>
                </div>
                <div class="flex items-center gap-3">
                    <label for="topNValue" class="text-sm font-medium text-gray-600">Show Top/Lowest:</label>
                    <input type="number" id="topNValue" value="5" min="1" class="w-24 p-2 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500 shadow-sm">
                </div>
            </div>

            <div id="summaryTableContainer" class="hidden">
                <h3 id="summaryTableName" class="text-xl sm:text-2xl font-semibold mb-4 text-gray-600"></h3>
                 <div class="overflow-x-auto rounded-lg shadow">
                    <table id="summaryTable" class="min-w-full w-full bg-white border border-gray-200">
                        <thead class="bg-gray-100">
                            </thead>
                        <tbody class="text-gray-700 text-sm">
                            </tbody>
                    </table>
                </div>
                <p id="noSummaryDataMessage" class="text-gray-500 mt-3 hidden">No data to display for this summary.</p>
            </div>
            
            <div id="aiSummaryArea" class="bg-white p-6 rounded-xl shadow-xl mt-8 hidden">
                <h3 class="text-xl sm:text-2xl font-semibold text-purple-700 mb-3">AI Generated Overview (Mail & Broker)</h3>
                <div id="aiSummaryContent" class="text-gray-700 prose max-w-none whitespace-pre-wrap"></div>
                <div id="aiSummaryLoading" class="text-purple-600 hidden flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating summary
                    <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
                <div id="aiSummaryError" class="text-red-600 mt-2 hidden"></div>
                
                <div id="mailBrokerChatContainer" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Chat about Mail/Broker Data:</h4>
                    <div id="aiChatDisplayMailBroker" class="chat-display"></div>
                    <div class="chat-input-area">
                        <input type="text" id="aiChatInputMailBroker" placeholder="Ask about players or items..." class="p-2">
                        <button id="aiChatSendButtonMailBroker" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">Send</button>
                    </div>
                    <div id="aiChatLoadingMailBroker" class="text-purple-600 hidden mt-2">Typing...</div>
                </div>
            </div>

            <div id="reportActions" class="mt-10 border-t pt-6 flex flex-col sm:flex-row flex-wrap gap-3">
                <button id="generateMailBrokerAISummaryButton" class="ai-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out w-full sm:w-auto hidden">AI Summary (Mail/Broker)</button>
                <button id="generateLotteryNarrativeButton" class="ai-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out w-full sm:w-auto hidden">âœ¨ Generate Lottery Trend Narrative</button>
                <button id="copyReportButton" class="ai-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out w-full sm:w-auto hidden">Copy Report for Sheets</button>
                <button id="createReportButton" class="ai-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out w-full sm:w-auto">Create Full Report</button>
            </div>
        </section>
    </div>

    <script>
        // --- DOM Element Variables ---
        var logFileInputElement, fileNameDisplayElement, 
            processMailBrokerButtonElement, processLotteryButtonElement, feedbackAreaElement, reportAreaElement,
            mailTableContainerElement, mailTransactionsTableTheadElement, mailTransactionsTableBodyElement, noMailTransactionsMessageElement,
            brokerTableContainerElement, brokerTransactionsTableTheadElement, brokerTransactionsTableBodyElement, noBrokerTransactionsMessageElement,
            lotteryAnalysisSectionElement, lotteryResultsTableTheadElement, lotteryResultsTableBodyElement, noLotteryResultsMessageElement,
            lotteryAnomaliesContainerElement, lotteryAnomaliesListElement, anomalyCountElement, 
            lotteryDetailedWinStatsContainerElement, lotteryDetailedStatsTableBodyElement, lotteryDetailedStatsTableHeadElement,
            lotterySummaryMetricsContainerElement,
            lotteryFilterContainerElement, lotteryWinTypeFiltersElement,
            summaryControlsElement, topNValueElement, summaryButtons,
            summaryTableContainerElement, summaryTableNameElement, summaryTableElement, summaryTableHeadElement, summaryTableBodyElement, noSummaryDataMessageElement,
            generateMailBrokerAISummaryButtonElement, aiSummaryAreaElement, aiSummaryContentElement, aiSummaryLoadingElement, aiSummaryErrorElement,
            generateLotteryNarrativeButtonElement, copyReportButtonElement, aiLotteryNarrativeAreaElement, aiLotteryNarrativeContentElement, aiLotteryNarrativeLoadingElement, aiLotteryNarrativeErrorElement,
            mailBrokerChatContainerElement, aiChatDisplayMailBrokerElement, aiChatInputMailBrokerElement, aiChatSendButtonMailBrokerElement, aiChatLoadingMailBrokerElement,
            lotteryChatContainerElement, aiChatDisplayLotteryElement, aiChatInputLotteryElement, aiChatSendButtonLotteryElement, aiChatLoadingLotteryElement,
            startDateInputElement, endDateInputElement, clearDateFilterButtonElement, activeFilterInfoElement, filterDateRangeElement, dateFilterContainerElement,
            toggleMailTableBtn, mailTableContent, toggleBrokerTableBtn, brokerTableContent, toggleAnomaliesBtn, anomaliesContent,
            toggleLotteryTableBtn, lotteryTableContent, toggleDetailedStatsBtn, detailedStatsContent,
            mailResizeHandle, brokerResizeHandle, anomaliesResizeHandle, lotteryResizeHandle, detailedStatsResizeHandle,
            skippedLogsContainer, skippedLogsContent, toggleSkippedLogsBtn, skippedLogsList, skippedLogsResizeHandle,
            reportActionsElement, createReportButtonElement;


        // --- Global State ---
        var allMailBrokerTransactions = []; 
        var allLotteryEvents = []; 
        var currentlyProcessedRawLines = []; 
        var skippedLogs = [];
        var aggregatedMailData = [];
        var aggregatedBrokerData = [];
        var aggregatedLotteryData = []; 
        var detailedLotteryStats = [];
        var currentSortStateMail = { column: 'times', direction: 'desc' }; 
        var currentSortStateBroker = { column: 'times', direction: 'desc' }; 
        var currentSortStateLottery = { column: 'winTypeDisplay', direction: 'desc' }; 
        var currentSortStateLotteryStats = { column: 'name', direction: 'desc' };
        var senderStats = {}; 
        var receiverStats = {}; 
        var currentOverallSenderHeader = "Seller/Sender"; 
        var currentOverallReceiverHeader = "Buyer/Receiver"; 
        var showOrderFillAmountColumnGlobal = false;
        var hasMailLogsGlobal = false; 
        var hasBrokerLogsGlobal = false;
        var hasLotteryLogsGlobal = false; 
        var mailBrokerChatHistory = [];
        var lotteryChatHistory = [];
        var lastProcessedLogType = null; 
        var logFileMinDate = null;
        var logFileMaxDate = null;
        var excludedWinTypes = new Set();


        const TICKET_PRICE = 3;
        const EXPECTED_WIN_RANGES = {
            '0': { name: 'Jackpot', min: 0, max: Infinity }, 
            '1': { name: 'GrandPrize', amounts: [10000, 100000, 200000] },
            '2': { name: 'BigWin', amounts: [50, 300, 2000] },
            '3': { name: 'Win', amounts: [3, 6, 18] },
            '4': { name: 'NoWin', amounts: [0] }
        };
        const LOTTERY_CHART_COLORS = ['#8884d8', '#82ca9d', '#ffc658', '#ff7300', '#8dd1e1', '#d0ed57', '#ffc0cb'];
        // Added for custom lottery sorting
        const lotteryWinTypeSortOrder = {
            'Jackpot': 1,
            'GrandPrize': 2,
            'BigWin': 3,
            'Win': 4,
            'NoWin': 5
        };


        // --- Regex for Parsing ---
        const logPayloadWrapperRegex = /{""log"":""(.*?)""}/; 
        const mailDataRegex =           /^\[Mail\] SendMail (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\] OtherName\[(.*?)\]$/;
        const brokerBuyItemRegex =      /^\[Broker\] BuyItem (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\] SellerName\[(.*?)\]$/;
        const brokerSellItemRegex =     /^\[Broker\] BrokerSellItem (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\]$/;
        const brokerCancelSellRegex =   /^\[Broker\] CancelSell (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\]$/;
        const brokerFillBuyOrderRegex = /^\[Broker\] FillBuyOrder (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\] Amount\[(\d+)\] SellerName\[(.*?)\]$/; 
        const brokerNewBuyOrderRegex =  /^\[Broker\] NewBuyOrder (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\](?: Amount\[(\d+)\])?$/; 
        const brokerCancelOrderRegex =  /^\[Broker\] CancelOrder (.*?) N\[(.*?)\] Q\[(\d+)\] C\[(\d+)\]$/; 
        
        // --- Utility Functions ---
        function setupCollapsible(button, content) {
            if (button && content) {
                button.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    button.classList.toggle('collapsed');
                });
            }
        }

        function setupDragToResize(handle, container) {
            if (!handle || !container) return;
            
            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                
                const startY = e.clientY;
                const startHeight = parseInt(window.getComputedStyle(container).maxHeight, 10);
                
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';

                function onMouseMove(moveEvent) {
                    const deltaY = moveEvent.clientY - startY;
                    let newHeight = startHeight + deltaY;
                    newHeight = Math.max(100, newHeight); // Enforce a minimum height of 100px
                    container.style.maxHeight = newHeight + 'px';
                }

                function onMouseUp() {
                    document.body.style.userSelect = '';
                    document.body.style.webkitUserSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements
            logFileInputElement = document.getElementById('logFileInput');
            fileNameDisplayElement = document.getElementById('fileNameDisplay');
            processMailBrokerButtonElement = document.getElementById('processMailBrokerButton');
            processLotteryButtonElement = document.getElementById('processLotteryButton');
            feedbackAreaElement = document.getElementById('feedbackArea');
            reportAreaElement = document.getElementById('reportArea');
            
            startDateInputElement = document.getElementById('startDate');
            endDateInputElement = document.getElementById('endDate');
            clearDateFilterButtonElement = document.getElementById('clearDateFilterButton');
            activeFilterInfoElement = document.getElementById('activeFilterInfo');
            filterDateRangeElement = document.getElementById('filterDateRange');
            dateFilterContainerElement = document.getElementById('dateFilterContainer');


            mailTableContainerElement = document.getElementById('mailTableContainer');
            if (mailTableContainerElement) { 
                mailTransactionsTableTheadElement = document.getElementById('mailTransactionsTable').getElementsByTagName('thead')[0];
                mailTransactionsTableBodyElement = document.getElementById('mailTransactionsTable').getElementsByTagName('tbody')[0];
            }
            noMailTransactionsMessageElement = document.getElementById('noMailTransactionsMessage');

            brokerTableContainerElement = document.getElementById('brokerTableContainer');
            if (brokerTableContainerElement) { 
                brokerTransactionsTableTheadElement = document.getElementById('brokerTransactionsTable').getElementsByTagName('thead')[0];
                brokerTransactionsTableBodyElement = document.getElementById('brokerTransactionsTable').getElementsByTagName('tbody')[0];
            }
            noBrokerTransactionsMessageElement = document.getElementById('noBrokerTransactionsMessage');

            lotteryAnalysisSectionElement = document.getElementById('lotteryAnalysisSection');
            const lotteryResultsTable = document.getElementById('lotteryResultsTable');
            if (lotteryResultsTable) {
                lotteryResultsTableTheadElement = lotteryResultsTable.getElementsByTagName('thead')[0];
                lotteryResultsTableBodyElement = lotteryResultsTable.getElementsByTagName('tbody')[0];
            }
            noLotteryResultsMessageElement = document.getElementById('noLotteryResultsMessage');
            
            lotterySummaryMetricsContainerElement = document.getElementById('lotterySummaryMetricsContainer');
            lotteryAnomaliesContainerElement = document.getElementById('lotteryAnomaliesContainer');
            lotteryAnomaliesListElement = document.getElementById('lotteryAnomaliesList');
            anomalyCountElement = document.getElementById('anomalyCount');
            lotteryFilterContainerElement = document.getElementById('lotteryFilterContainer');
            lotteryWinTypeFiltersElement = document.getElementById('lotteryWinTypeFilters');

            lotteryDetailedWinStatsContainerElement = document.getElementById('lotteryDetailedWinStatsContainer');
            const detailedStatsTable = document.getElementById('lotteryDetailedStatsTable');
            if (detailedStatsTable) {
                 lotteryDetailedStatsTableHeadElement = detailedStatsTable.getElementsByTagName('thead')[0];
                 lotteryDetailedStatsTableBodyElement = detailedStatsTable.getElementsByTagName('tbody')[0];
            }

            summaryControlsElement = document.getElementById('summaryControls');
            topNValueElement = document.getElementById('topNValue');
            summaryButtons = document.querySelectorAll('.summary-btn');
            
            summaryTableContainerElement = document.getElementById('summaryTableContainer');
            summaryTableNameElement = document.getElementById('summaryTableName');
            summaryTableElement = document.getElementById('summaryTable');
             if (summaryTableElement) { 
                summaryTableHeadElement = summaryTableElement.getElementsByTagName('thead')[0];
                summaryTableBodyElement = summaryTableElement.getElementsByTagName('tbody')[0];
            }
            noSummaryDataMessageElement = document.getElementById('noSummaryDataMessage');

            generateMailBrokerAISummaryButtonElement = document.getElementById('generateMailBrokerAISummaryButton');
            aiSummaryAreaElement = document.getElementById('aiSummaryArea');
            aiSummaryContentElement = document.getElementById('aiSummaryContent');
            aiSummaryLoadingElement = document.getElementById('aiSummaryLoading');
            aiSummaryErrorElement = document.getElementById('aiSummaryError');

            generateLotteryNarrativeButtonElement = document.getElementById('generateLotteryNarrativeButton');
            copyReportButtonElement = document.getElementById('copyReportButton');
            aiLotteryNarrativeAreaElement = document.getElementById('aiLotteryNarrativeArea');
            aiLotteryNarrativeContentElement = document.getElementById('aiLotteryNarrativeContent');
            aiLotteryNarrativeLoadingElement = document.getElementById('aiLotteryNarrativeLoading');
            aiLotteryNarrativeErrorElement = document.getElementById('aiLotteryNarrativeError');

            // Chatbox elements
            mailBrokerChatContainerElement = document.getElementById('mailBrokerChatContainer');
            aiChatDisplayMailBrokerElement = document.getElementById('aiChatDisplayMailBroker');
            aiChatInputMailBrokerElement = document.getElementById('aiChatInputMailBroker');
            aiChatSendButtonMailBrokerElement = document.getElementById('aiChatSendButtonMailBroker');
            aiChatLoadingMailBrokerElement = document.getElementById('aiChatLoadingMailBroker');

            lotteryChatContainerElement = document.getElementById('lotteryChatContainer');
            aiChatDisplayLotteryElement = document.getElementById('aiChatDisplayLottery');
            aiChatInputLotteryElement = document.getElementById('aiChatInputLottery');
            aiChatSendButtonLotteryElement = document.getElementById('aiChatSendButtonLottery');
            aiChatLoadingLotteryElement = document.getElementById('aiChatLoadingLottery');

            // Collapsible table elements
            toggleMailTableBtn = document.getElementById('toggleMailTableBtn');
            mailTableContent = document.getElementById('mailTableContent');
            toggleBrokerTableBtn = document.getElementById('toggleBrokerTableBtn');
            brokerTableContent = document.getElementById('brokerTableContent');
            toggleAnomaliesBtn = document.getElementById('toggleAnomaliesBtn');
            anomaliesContent = document.getElementById('anomaliesContent');
            toggleLotteryTableBtn = document.getElementById('toggleLotteryTableBtn');
            lotteryTableContent = document.getElementById('lotteryTableContent');
            toggleDetailedStatsBtn = document.getElementById('toggleDetailedStatsBtn');
            detailedStatsContent = document.getElementById('detailedStatsContent');
            toggleSkippedLogsBtn = document.getElementById('toggleSkippedLogsBtn');
            skippedLogsContent = document.getElementById('skippedLogsContent');
            
            // Resize handle elements
            mailResizeHandle = document.getElementById('mailResizeHandle');
            brokerResizeHandle = document.getElementById('brokerResizeHandle');
            anomaliesResizeHandle = document.getElementById('anomaliesResizeHandle');
            lotteryResizeHandle = document.getElementById('lotteryResizeHandle');
            detailedStatsResizeHandle = document.getElementById('detailedStatsResizeHandle');
            skippedLogsResizeHandle = document.getElementById('skippedLogsResizeHandle');
            
            // Skipped Logs container
            skippedLogsContainer = document.getElementById('skippedLogsContainer');
            skippedLogsList = document.getElementById('skippedLogsList');
            
            // Report Actions
            reportActionsElement = document.getElementById('reportActions');
            createReportButtonElement = document.getElementById('createReportButton');


            // Attach event listeners
            if (logFileInputElement) {
                logFileInputElement.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    const hasFile = !!file;

                    if (hasFile) {
                        if (fileNameDisplayElement) fileNameDisplayElement.textContent = file.name;
                        processMailBrokerButtonElement.classList.remove('bg-gray-400');
                        processMailBrokerButtonElement.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        processLotteryButtonElement.classList.remove('bg-gray-400');
                        processLotteryButtonElement.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    } else {
                        if (fileNameDisplayElement) fileNameDisplayElement.textContent = "";
                        processMailBrokerButtonElement.classList.add('bg-gray-400');
                        processMailBrokerButtonElement.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        processLotteryButtonElement.classList.add('bg-gray-400');
                        processLotteryButtonElement.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    }
                });
            }

            if(processMailBrokerButtonElement) processMailBrokerButtonElement.addEventListener('click', () => handleProcessRequest('mailbroker'));
            if(processLotteryButtonElement) processLotteryButtonElement.addEventListener('click', () => handleProcessRequest('lottery'));

            if(clearDateFilterButtonElement) {
                clearDateFilterButtonElement.addEventListener('click', () => {
                    if(startDateInputElement && logFileMinDate) startDateInputElement.value = logFileMinDate.toISOString().split('T')[0];
                    if(endDateInputElement && logFileMaxDate) endDateInputElement.value = logFileMaxDate.toISOString().split('T')[0];
                    if(activeFilterInfoElement) activeFilterInfoElement.classList.add('hidden');
                    
                    if (lastProcessedLogType && currentlyProcessedRawLines.length > 0) {
                         applyFiltersAndProcess(lastProcessedLogType); 
                    }
                });
            }
            if (startDateInputElement) {
                startDateInputElement.addEventListener('change', () => {
                     if (lastProcessedLogType && currentlyProcessedRawLines.length > 0) applyFiltersAndProcess(lastProcessedLogType);
                });
            }
            if (endDateInputElement) {
                endDateInputElement.addEventListener('change', () => {
                    if (lastProcessedLogType && currentlyProcessedRawLines.length > 0) applyFiltersAndProcess(lastProcessedLogType);
                });
            }


             if (aiChatInputMailBrokerElement) {
                aiChatInputMailBrokerElement.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && this.value.trim() !== '') {
                        aiChatSendButtonMailBrokerElement.click();
                    }
                });
            }
            if (aiChatInputLotteryElement) {
                aiChatInputLotteryElement.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && this.value.trim() !== '') {
                        aiChatSendButtonLotteryElement.click();
                    }
                });
            }


            if(summaryButtons) summaryButtons.forEach(button => {
                button.addEventListener('click', (event) => displaySummary(event.target.dataset.type));
            });
            if(topNValueElement) topNValueElement.addEventListener('change', () => {
                if (summaryTableContainerElement && !summaryTableContainerElement.classList.contains('hidden')) {
                    const activeSummaryType = summaryTableNameElement.dataset.activeType;
                    if (activeSummaryType) displaySummary(activeSummaryType);
                }
            });
            if(generateMailBrokerAISummaryButtonElement) generateMailBrokerAISummaryButtonElement.addEventListener('click', handleGenerateAISummary);
            if(generateLotteryNarrativeButtonElement) generateLotteryNarrativeButtonElement.addEventListener('click', handleGenerateLotteryNarrative);
             if(aiChatSendButtonMailBrokerElement) aiChatSendButtonMailBrokerElement.addEventListener('click', handleMailBrokerChatQuery);
            if(aiChatSendButtonLotteryElement) aiChatSendButtonLotteryElement.addEventListener('click', handleLotteryChatQuery);
            if(copyReportButtonElement) copyReportButtonElement.addEventListener('click', handleCopyReport);
            if(createReportButtonElement) createReportButtonElement.addEventListener('click', generateHtmlReport);

            setupCollapsible(toggleMailTableBtn, mailTableContent);
            setupCollapsible(toggleBrokerTableBtn, brokerTableContent);
            setupCollapsible(toggleAnomaliesBtn, anomaliesContent);
            setupCollapsible(toggleLotteryTableBtn, lotteryTableContent);
            setupCollapsible(toggleDetailedStatsBtn, detailedStatsContent);
            setupCollapsible(toggleSkippedLogsBtn, skippedLogsContent);

            if(mailTableContent) setupDragToResize(mailResizeHandle, mailTableContent.querySelector('.table-scroll-container'));
            if(brokerTableContent) setupDragToResize(brokerResizeHandle, brokerTableContent.querySelector('.table-scroll-container'));
            if(anomaliesContent) setupDragToResize(anomaliesResizeHandle, anomaliesContent.querySelector('.table-scroll-container'));
            if(lotteryTableContent) setupDragToResize(lotteryResizeHandle, lotteryTableContent.querySelector('.table-scroll-container'));
            if(detailedStatsContent) setupDragToResize(detailedStatsResizeHandle, detailedStatsContent.querySelector('.table-scroll-container'));
            if(skippedLogsContent) setupDragToResize(skippedLogsResizeHandle, skippedLogsContent.querySelector('.table-scroll-container'));


            document.querySelectorAll('#mailTransactionsTable .sortable-header, #brokerTransactionsTable .sortable-header, #lotteryResultsTable .sortable-header, #lotteryDetailedStatsTable .sortable-header').forEach(header => {
                header.addEventListener('click', () => handleSortRequest(header.dataset.sortBy, header.dataset.tableType));
            });
        });
        
        // --- Core Logic Functions ---
        function handleProcessRequest(logFileType) {
            const file = logFileInputElement.files[0];
            if (!file) {
                feedbackAreaElement.textContent = "Please choose a log file.";
                // Reset UI
                reportAreaElement.classList.add('hidden');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const logText = event.target.result;
                currentlyProcessedRawLines = logText.split('\n').filter(line => line.trim() !== ''); // Filter empty lines upfront
                lastProcessedLogType = logFileType;
                setInitialDateRangeForAllLogs();
                applyFiltersAndProcess(logFileType);
            };
            reader.onerror = (event) => {
                console.error("File could not be read! Code " + event.target.error.code);
                feedbackAreaElement.textContent = "Error reading file. See console for details.";
                reportAreaElement.classList.add('hidden');
            };
            reader.readAsText(file);
        }
        
        function setInitialDateRangeForAllLogs() {
            let minTimestamp = null;
            let maxTimestamp = null;
            
            currentlyProcessedRawLines.forEach(line => {
                let ts = extractTimestampFromLogLine(line); 
                if (ts instanceof Date && !isNaN(ts)) {
                    if (!minTimestamp || ts < minTimestamp) minTimestamp = ts;
                    if (!maxTimestamp || ts > maxTimestamp) maxTimestamp = ts;
                }
            });

            logFileMinDate = minTimestamp;
            logFileMaxDate = maxTimestamp;

            if (startDateInputElement && endDateInputElement && dateFilterContainerElement) {
                if (logFileMinDate && logFileMaxDate) {
                    const minDateStr = logFileMinDate.toISOString().split('T')[0];
                    const maxDateStr = logFileMaxDate.toISOString().split('T')[0];
                    startDateInputElement.min = minDateStr;
                    startDateInputElement.max = maxDateStr; 
                    endDateInputElement.min = minDateStr;   
                    endDateInputElement.max = maxDateStr;
                    
                    startDateInputElement.value = minDateStr; 
                    endDateInputElement.value = maxDateStr;

                    dateFilterContainerElement.classList.remove('hidden');
                } else {
                    dateFilterContainerElement.classList.add('hidden'); 
                    if(feedbackAreaElement) feedbackAreaElement.textContent += " Could not determine date range from logs.";
                }
            }
        }


        function applyFiltersAndProcess(logFileType) {
            let parsedEntries = [];
            skippedLogs = []; // Reset skipped logs for each process run
            
            currentlyProcessedRawLines.forEach(line => {
                let entry = null;
                if (logFileType === 'mailbroker') {
                    entry = parseMailBrokerLogEntry(line);
                } else if (logFileType === 'lottery') {
                    entry = parseLotteryLogEntry(line);
                }
                
                if (entry) {
                    parsedEntries.push(entry);
                } else {
                    skippedLogs.push(line); // Store the line if parsing failed
                }
            });

            const totalParsed = parsedEntries.length;
            const totalSkipped = skippedLogs.length;
            const totalLinesInFile = totalParsed + totalSkipped;
            
            const startDateValue = startDateInputElement ? startDateInputElement.value : null;
            const endDateValue = endDateInputElement ? endDateInputElement.value : null;
            let filteredEntries = parsedEntries;
            let dateFilteredSkipped = 0;

            if (startDateValue || endDateValue) {
                const startDate = startDateValue ? new Date(startDateValue + "T00:00:00.000Z") : null;
                const endDate = endDateValue ? new Date(endDateValue + "T23:59:59.999Z") : null;

                const originalCount = filteredEntries.length;
                filteredEntries = parsedEntries.filter(entry => {
                    if (!entry.timestamp || !(entry.timestamp instanceof Date) || isNaN(entry.timestamp)) return false;
                    if (startDate && entry.timestamp < startDate) return false;
                    if (endDate && entry.timestamp > endDate) return false;
                    return true;
                });
                dateFilteredSkipped = originalCount - filteredEntries.length;

                if (activeFilterInfoElement && filterDateRangeElement) {
                    activeFilterInfoElement.classList.remove('hidden');
                    const startDisplay = startDate ? `${(startDate.getUTCMonth() + 1).toString().padStart(2, '0')}/${startDate.getUTCDate().toString().padStart(2, '0')}/${startDate.getUTCFullYear()}` : 'Any';
                    const endDisplay = endDate ? `${(endDate.getUTCMonth() + 1).toString().padStart(2, '0')}/${endDate.getUTCDate().toString().padStart(2, '0')}/${endDate.getUTCFullYear()}` : 'Any';
                    filterDateRangeElement.textContent = `${startDisplay} to ${endDisplay}`;
                }
            } else {
                if (activeFilterInfoElement) activeFilterInfoElement.classList.add('hidden');
            }
            
            const displayedCount = filteredEntries.length;
            const parsingSkippedCount = totalSkipped;
            const finalSkippedCount = parsingSkippedCount + dateFilteredSkipped;
            const logTypeName = logFileType === 'lottery' ? 'Lottery' : 'Mail/Broker';
            const entryName = logFileType === 'lottery' ? 'entries' : 'transactions';
            
            if (finalSkippedCount > 0) {
                 feedbackAreaElement.textContent = `Displaying ${displayedCount} ${logTypeName} ${entryName} out of ${totalLinesInFile} total logs â€” ${finalSkippedCount} skipped.`;
            } else {
                feedbackAreaElement.textContent = `Displaying ${displayedCount} ${logTypeName} ${entryName} out of ${totalLinesInFile} total logs.`;
            }


            // Reset UI and State
            if(mailTableContainerElement) mailTableContainerElement.classList.add('hidden');
            if(brokerTableContainerElement) brokerTableContainerElement.classList.add('hidden');
            if(lotteryAnalysisSectionElement) lotteryAnalysisSectionElement.classList.add('hidden');
            if(reportAreaElement) reportAreaElement.classList.add('hidden'); 
            if(summaryControlsElement) summaryControlsElement.classList.add('hidden'); 
            if(reportActionsElement) reportActionsElement.classList.add('hidden');
            if(aiSummaryAreaElement) aiSummaryAreaElement.classList.add('hidden');
            if(aiLotteryNarrativeAreaElement) aiLotteryNarrativeAreaElement.classList.add('hidden');
            if(mailBrokerChatContainerElement) mailBrokerChatContainerElement.classList.add('hidden');
            if(lotteryChatContainerElement) lotteryChatContainerElement.classList.add('hidden');
            if(skippedLogsContainer) skippedLogsContainer.classList.add('hidden');

            // Reset all global data flags before processing
            hasMailLogsGlobal = false;
            hasBrokerLogsGlobal = false;
            hasLotteryLogsGlobal = false;
            let hasAnyData = false;
            
            // Reset visibility of all action buttons
            if (generateMailBrokerAISummaryButtonElement) generateMailBrokerAISummaryButtonElement.classList.add('hidden');
            if (generateLotteryNarrativeButtonElement) generateLotteryNarrativeButtonElement.classList.add('hidden');
            if (copyReportButtonElement) copyReportButtonElement.classList.add('hidden');
            if (createReportButtonElement) createReportButtonElement.classList.add('hidden');

            if (logFileType === 'mailbroker') {
                allMailBrokerTransactions = [...filteredEntries];
                processFilteredMailBroker(filteredEntries);
                hasAnyData = hasMailLogsGlobal || hasBrokerLogsGlobal;
                if(hasAnyData && reportActionsElement) {
                    generateMailBrokerAISummaryButtonElement.classList.remove('hidden');
                    createReportButtonElement.classList.remove('hidden');
                    copyReportButtonElement.classList.remove('hidden');
                }

            } else if (logFileType === 'lottery') {
                allLotteryEvents = [...filteredEntries];
                processFilteredLottery(filteredEntries);
                hasAnyData = hasLotteryLogsGlobal;
                if(hasAnyData && reportActionsElement){
                    generateLotteryNarrativeButtonElement.classList.remove('hidden');
                    copyReportButtonElement.classList.remove('hidden');
                    createReportButtonElement.classList.remove('hidden');
                }
            }
            
            // Centralized decision to show the main report area
            if (hasAnyData) {
                reportAreaElement.classList.remove('hidden');
                if (reportActionsElement) reportActionsElement.classList.remove('hidden');
            }

            if (skippedLogs.length > 0) {
                renderSkippedLogs();
                skippedLogsContainer.classList.remove('hidden');
            }
        }


        function mapWinTypeToDisplay(rawWinType) {
            return EXPECTED_WIN_RANGES[rawWinType]?.name || `Anomaly (Type ${rawWinType})`;
        }

        function isValidLotteryWinAmount(winType, amount) {
            const expected = EXPECTED_WIN_RANGES[winType];
            if (!expected) return false; 
            if (winType === '0') return amount >= 0; 
            return expected.amounts.includes(amount);
        }
        
        function parseMailBrokerLogEntry(logLine) { 
            try {
                let cleanedLogLine = logLine.trim();
                if (!cleanedLogLine) return null;

                let contentToParseForRegex = null;
                const parts = cleanedLogLine.split(',');

                if (parts.length >= 7 && parts[6]) {
                    let seventhField = parts[6].trim();
                    if (seventhField.startsWith("'") && seventhField.endsWith("'")) seventhField = seventhField.slice(1, -1);
                    if (seventhField.startsWith('"') && seventhField.endsWith('"')) seventhField = seventhField.slice(1, -1);
                    
                    const innerWrapperMatch = seventhField.match(logPayloadWrapperRegex);
                    if (innerWrapperMatch && innerWrapperMatch[1]) {
                        contentToParseForRegex = innerWrapperMatch[1];
                    } else if (seventhField.startsWith("[Mail]") || seventhField.startsWith("[Broker]")) {
                        contentToParseForRegex = seventhField; 
                    }
                }
                
                if (!contentToParseForRegex) {
                    const globalWrapperMatch = cleanedLogLine.match(logPayloadWrapperRegex);
                    if (globalWrapperMatch && globalWrapperMatch[1]) {
                        contentToParseForRegex = globalWrapperMatch[1];
                    } else if (cleanedLogLine.startsWith("[Mail]") || cleanedLogLine.startsWith("[Broker]")) {
                        contentToParseForRegex = cleanedLogLine;
                    }
                }

                if (contentToParseForRegex) {
                    let match;
                    let rawPriceValue; 
                    let orderFillAmount = null; 
                    let timestamp = extractTimestampFromLogLine(logLine);


                    match = contentToParseForRegex.match(mailDataRegex);
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10); 
                        return {
                            logType: 'Mail', 
                            displayLogType: 'Mail', 
                            receiver: match[1].trim().toLowerCase(),
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10),
                            orderFillAmount: null, 
                            price: rawPriceValue / 10000, 
                            sender: match[5].trim().toLowerCase(),
                            timestamp: timestamp 
                        };
                    }

                    match = contentToParseForRegex.match(brokerBuyItemRegex);
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10); 
                        return {
                            logType: 'BrokerBuyItem', 
                            displayLogType: 'BuyItem',
                            receiver: match[1].trim().toLowerCase(), 
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10),
                            orderFillAmount: null, 
                            price: rawPriceValue / 10000, 
                            sender: match[5].trim().toLowerCase(),   
                            timestamp: timestamp  
                        };
                    }

                    match = contentToParseForRegex.match(brokerSellItemRegex);
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10); 
                        return {
                            logType: 'BrokerSellItem',
                            displayLogType: 'SellItem',
                            sender: match[1].trim().toLowerCase(),   
                            receiver: 'broker_sell_listing', 
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10), 
                            orderFillAmount: null, 
                            price: rawPriceValue / 10000, 
                            timestamp: timestamp
                        };
                    }

                    match = contentToParseForRegex.match(brokerCancelSellRegex);
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10);
                        return {
                            logType: 'BrokerCancelSell',
                            displayLogType: 'CancelSell',
                            sender: match[1].trim().toLowerCase(), 
                            receiver: 'broker_cancelled_sell',
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10), 
                            orderFillAmount: null, 
                            price: rawPriceValue / 10000, 
                            timestamp: timestamp
                        };
                    }
                    
                    match = contentToParseForRegex.match(brokerFillBuyOrderRegex);
                    if (match) {
                        const originalOrderQty = parseInt(match[3], 10); 
                        const pricePerItem = parseInt(match[4], 10);     
                        orderFillAmount = parseInt(match[5], 10);      
                        rawPriceValue = orderFillAmount * pricePerItem;
                        return {
                            logType: 'BrokerFillBuyOrder',
                            displayLogType: 'FillBuyOrder',
                            sender: match[6].trim().toLowerCase(),   
                            receiver: match[1].trim().toLowerCase(), 
                            itemName: match[2].trim(),
                            quantity: originalOrderQty, 
                            orderFillAmount: orderFillAmount, 
                            price: rawPriceValue / 10000,
                            timestamp: timestamp
                        };
                    }

                    match = contentToParseForRegex.match(brokerNewBuyOrderRegex);
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10);
                        orderFillAmount = match[5] ? parseInt(match[5], 10) : parseInt(match[3], 10); 
                        return {
                            logType: 'BrokerNewBuyOrder',
                            displayLogType: 'NewBuyOrder',
                            sender: match[1].trim().toLowerCase(), 
                            receiver: 'broker_new_buy_order',
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10), 
                            orderFillAmount: orderFillAmount, 
                            price: rawPriceValue / 10000, 
                            timestamp: timestamp
                        };
                    }

                    match = contentToParseForRegex.match(brokerCancelOrderRegex); 
                    if (match) {
                        rawPriceValue = parseInt(match[4], 10);
                        return {
                            logType: 'BrokerCancelOrder',
                            displayLogType: 'CancelOrder',
                            sender: match[1].trim().toLowerCase(), 
                            receiver: 'broker_cancelled_buy_order', 
                            itemName: match[2].trim(),
                            quantity: parseInt(match[3], 10), 
                            orderFillAmount: null, 
                            price: rawPriceValue / 10000, 
                            timestamp: timestamp
                        };
                    }
                }
                return null; 
            } catch (error) {
                return null;
            }
        }

        function parseLotteryLogEntry(logLine) {
            try {
                let cleanedLogLine = logLine.trim();
                if (!cleanedLogLine) return null;
        
                let jsonString = null;
                const parts = cleanedLogLine.split(',');
        
                if (parts.length >= 7 && parts[6] && parts[6].includes('"iWinType"')) {
                    let fieldContent = parts[6].trim();
                    if (fieldContent.startsWith("'") && fieldContent.endsWith("'")) {
                        fieldContent = fieldContent.slice(1, -1);
                    }
                    if (fieldContent.startsWith('"') && fieldContent.endsWith('"')) {
                       fieldContent = fieldContent.slice(1, -1);
                    }
        
                    const lastPipeIndex = fieldContent.lastIndexOf('|');
                    let potentialJson = lastPipeIndex !== -1 ? fieldContent.substring(lastPipeIndex + 1) : fieldContent;
                    
                    const firstBrace = potentialJson.indexOf('{');
                    const lastBrace = potentialJson.lastIndexOf('}');

                    if (firstBrace !== -1 && lastBrace > firstBrace) {
                        jsonString = potentialJson.substring(firstBrace, lastBrace + 1);
                    } else if (potentialJson.trim().startsWith('{') && potentialJson.trim().endsWith('}')) {
                        jsonString = potentialJson.trim();
                    }
                } else if (cleanedLogLine.startsWith('{') && cleanedLogLine.endsWith('}') && 
                           cleanedLogLine.includes('"iWinType"') && cleanedLogLine.includes('"iWinAmount"') && cleanedLogLine.includes('"name"')) {
                    jsonString = cleanedLogLine;
                } else if (cleanedLogLine.includes('|{') && cleanedLogLine.includes('"iWinType"')){ 
                    const lastPipeIndex = cleanedLogLine.lastIndexOf('|');
                     if (lastPipeIndex !== -1) {
                        let potentialJson = cleanedLogLine.substring(lastPipeIndex + 1);
                        if (potentialJson.trim().startsWith('{') && potentialJson.trim().endsWith('}')) {
                            jsonString = potentialJson.trim();
                        }
                     }
                }
        
                if (jsonString) {
                    const lotteryData = JSON.parse(jsonString);
                    if (lotteryData && typeof lotteryData.name === 'string' &&
                        typeof lotteryData.iWinType === 'string' && typeof lotteryData.iWinAmount === 'string') {
                        const rawWinType = lotteryData.iWinType;
                        const goldWon = parseInt(lotteryData.iWinAmount, 10);
                        
                        const isAnomaly = !EXPECTED_WIN_RANGES[rawWinType] || !isValidLotteryWinAmount(rawWinType, goldWon);
                        let finalWinTypeDisplay = mapWinTypeToDisplay(rawWinType);
                        
                        if (isAnomaly && EXPECTED_WIN_RANGES[rawWinType]) {
                             finalWinTypeDisplay = `Anomaly (${EXPECTED_WIN_RANGES[rawWinType].name})`;
                        }

                        return {
                            logType: 'Lottery', 
                            playerName: lotteryData.name,
                            winTypeDisplay: finalWinTypeDisplay,
                            rawWinType: rawWinType,
                            goldWon: goldWon,
                            timestamp: extractTimestampFromLogLine(logLine), 
                            isAnomaly: isAnomaly,
                            originalLine: logLine 
                        };
                    }
                }
                return null;
            } catch (e) {
                return null;
            }
        }

        function extractTimestampFromLogLine(logLine) {
            const csvEndTimestampMatch = logLine.match(/,"'(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z)'"(?:,|$)/); 
            if (csvEndTimestampMatch && csvEndTimestampMatch[1]) {
                 return new Date(csvEndTimestampMatch[1]);
            }
            
            const isoTimestampMatch = logLine.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z?/);
            if (isoTimestampMatch && isoTimestampMatch[0]) {
                const potentialQuotedMatch = logLine.match(/'(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)'/);
                if (potentialQuotedMatch && potentialQuotedMatch[1]) {
                    return new Date(potentialQuotedMatch[1]);
                }
                return new Date(isoTimestampMatch[0]);
            }

            const spaceTimestampMatch = logLine.match(/(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d+)\sUTC\+\d+/);
             if (spaceTimestampMatch && spaceTimestampMatch[1]) {
                return new Date(spaceTimestampMatch[1].replace(' ', 'T') + 'Z'); 
            }
            return null; 
        }


        function processFilteredMailBroker(filteredEntries) {
            let mailTransactions = [];
            let brokerTransactions = [];
            senderStats = {}; 
            receiverStats = {};
            showOrderFillAmountColumnGlobal = false; 
            
            filteredEntries.forEach(transaction => {
                if (transaction.logType === 'Mail') {
                    hasMailLogsGlobal = true;
                    mailTransactions.push(transaction);
                } else if (transaction.logType.startsWith('Broker')) {
                    hasBrokerLogsGlobal = true;
                    brokerTransactions.push(transaction);
                    if (transaction.orderFillAmount !== null) {
                        showOrderFillAmountColumnGlobal = true; 
                    }
                }
                
                const senderKey = transaction.sender;
                const receiverKey = transaction.receiver;
                
                senderStats[senderKey] = senderStats[senderKey] || { totalQuantity: 0, totalPrice: 0, count: 0, displayName: senderKey };
                senderStats[senderKey].totalQuantity += transaction.quantity;
                senderStats[senderKey].totalPrice += transaction.price; 
                senderStats[senderKey].count++;
                
                receiverStats[receiverKey] = receiverStats[receiverKey] || { totalQuantity: 0, totalPrice: 0, count: 0, displayName: receiverKey };
                receiverStats[receiverKey].totalQuantity += transaction.quantity;
                receiverStats[receiverKey].totalPrice += transaction.price; 
                receiverStats[receiverKey].count++;
            });

            if (hasMailLogsGlobal && !hasBrokerLogsGlobal) {
                currentOverallSenderHeader = "Sender";
                currentOverallReceiverHeader = "Receiver";
            } else if (!hasMailLogsGlobal && hasBrokerLogsGlobal) {
                currentOverallSenderHeader = "Seller";
                currentOverallReceiverHeader = "Buyer";
            } else { 
                currentOverallSenderHeader = "Seller/Sender";
                currentOverallReceiverHeader = "Buyer/Receiver";
            }
            
            if (hasMailLogsGlobal && mailTransactions.length > 0) {
                aggregatedMailData = aggregateTransactions(mailTransactions, false); 
                sortAggregatedData(aggregatedMailData, currentSortStateMail.column, currentSortStateMail.direction);
                renderMailTransactionsTable();
                updateSortIndicators('mail');
                mailTableContainerElement.classList.remove('hidden');
                noMailTransactionsMessageElement.classList.toggle('hidden', aggregatedMailData.length > 0);
            } else {
                mailTableContainerElement.classList.add('hidden');
            }

            if (hasBrokerLogsGlobal && brokerTransactions.length > 0) {
                aggregatedBrokerData = aggregateTransactions(brokerTransactions, true); 
                sortAggregatedData(aggregatedBrokerData, currentSortStateBroker.column, currentSortStateBroker.direction);
                renderBrokerTransactionsTable();
                updateSortIndicators('broker');
                brokerTableContainerElement.classList.remove('hidden');
                noBrokerTransactionsMessageElement.classList.toggle('hidden', aggregatedBrokerData.length > 0);

                if(brokerTransactionsTableTheadElement){ 
                    const amountSpecificHeaderCell = brokerTransactionsTableTheadElement.querySelector('th[data-sort-by="orderFillAmount"]');
                    if (amountSpecificHeaderCell) {
                        amountSpecificHeaderCell.classList.toggle('hidden', !showOrderFillAmountColumnGlobal);
                    }
                }
            } else {
                brokerTableContainerElement.classList.add('hidden');
            }
            
            summaryControlsElement.classList.toggle('hidden', !(hasMailLogsGlobal || hasBrokerLogsGlobal));
        }

        function processFilteredLottery(filteredEntries) {
            hasLotteryLogsGlobal = filteredEntries.length > 0;

            if (hasLotteryLogsGlobal) {
                lotteryAnalysisSectionElement.classList.remove('hidden');
                // Then, populate and render the content
                excludedWinTypes.clear();
                generateWinTypeFilters(allLotteryEvents);
                renderLotteryAnalysis(); // Now renders into a visible element

            } else {
                lotteryAnalysisSectionElement.classList.add('hidden');
            }
        }
        
        function generateWinTypeFilters(lotteryEvents) {
            if (!lotteryWinTypeFiltersElement) return;
            lotteryWinTypeFiltersElement.innerHTML = ''; // Clear old filters
            const uniqueWinTypes = [...new Set(lotteryEvents.map(e => e.winTypeDisplay))].sort();

            if (uniqueWinTypes.length > 1) { // Only show filters if there's something to filter
                lotteryFilterContainerElement.classList.remove('hidden');
            } else {
                lotteryFilterContainerElement.classList.add('hidden');
                return;
            }

            uniqueWinTypes.forEach(winType => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-${winType.replace(/\s+/g, '-')}`;
                checkbox.value = winType;
                checkbox.checked = !excludedWinTypes.has(winType);
                checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer';

                checkbox.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        excludedWinTypes.delete(winType);
                    } else {
                        excludedWinTypes.add(winType);
                    }
                    renderLotteryAnalysis(); // Re-render everything
                });

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = winType;
                label.className = 'ml-2 block text-sm text-gray-900 cursor-pointer';
                
                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                lotteryWinTypeFiltersElement.appendChild(wrapper);
            });
        }
        
        function renderLotteryAnalysis() {
            // Apply the win type exclusion filter
            const filteredEvents = allLotteryEvents.filter(e => !excludedWinTypes.has(e.winTypeDisplay));

            // Anomalies are always detected from the full, unfiltered dataset
            const anomalies = allLotteryEvents.filter(e => e.isAnomaly);
            
            // --- All calculations below are based on the interactively `filteredEvents` ---
            const totalTickets = filteredEvents.length;
            const totalGoldIn = totalTickets * TICKET_PRICE;
            const totalGoldOut = filteredEvents.reduce((sum, event) => sum + event.goldWon, 0);
            const netGoldGenerated = totalGoldOut - totalGoldIn;
            const totalWinningTickets = filteredEvents.filter(e => e.winTypeDisplay !== 'NoWin' && !e.winTypeDisplay.includes('Anomaly')).length;
            const overallWinRate = totalTickets > 0 ? (totalWinningTickets / totalTickets) * 100 : 0;
            const rtp = totalGoldIn > 0 ? (totalGoldOut / totalGoldIn) * 100 : 0;

            document.getElementById('lotteryTotalTickets').textContent = totalTickets.toLocaleString();
            document.getElementById('lotteryGoldIn').textContent = totalGoldIn.toLocaleString();
            document.getElementById('lotteryTotalWinningTickets').textContent = totalWinningTickets.toLocaleString();
            document.getElementById('lotteryGoldOut').textContent = totalGoldOut.toLocaleString();
            const netGoldEl = document.getElementById('lotteryNetGold');
            netGoldEl.textContent = `${netGoldGenerated >= 0 ? '+' : ''}${netGoldGenerated.toLocaleString()}`;
            netGoldEl.className = `metrics-value ${netGoldGenerated >= 0 ? 'negative-net' : 'positive-net'}`;
            document.getElementById('lotteryWinRate').textContent = `${overallWinRate.toFixed(2)}%`;
            const rtpEl = document.getElementById('lotteryRTP');
            rtpEl.textContent = `${rtp.toFixed(2)}%`;
            rtpEl.className = `metrics-value ${rtp > 100 ? 'negative-net' : (rtp < 100 && rtp > 0 ? 'positive-net' : 'text-gray-900')}`;
            document.getElementById('lotteryAnomalyCount').textContent = anomalies.length.toLocaleString();

            // Anomaly List display (based on full dataset)
            anomalyCountElement.textContent = anomalies.length;
            lotteryAnomaliesListElement.innerHTML = '';
            if (anomalies.length > 0) {
                lotteryAnomaliesContainerElement.classList.remove('hidden');
                anomalies.forEach(anomaly => {
                    const li = document.createElement('li');
                    const anomalyType = anomaly.winTypeDisplay.startsWith("Anomaly") ? 'Invalid Win Type/Amount' : 'Invalid Win Amount';
                    const severity = anomaly.winTypeDisplay.startsWith("Anomaly (Type") ? 'HIGH' : 'MEDIUM';

                    li.className = `p-2 rounded border text-xs ${severity === 'HIGH' ? 'bg-red-100 border-red-300 text-red-700' : 'bg-yellow-100 border-yellow-300 text-yellow-700'}`;
                    li.innerHTML = `<strong>${anomalyType}:</strong> Player: ${anomaly.playerName}, Type: ${anomaly.rawWinType}, Amount: ${anomaly.goldWon.toLocaleString()} gold, Time: ${anomaly.timestamp ? anomaly.timestamp.toLocaleString() : 'N/A'}`;
                    lotteryAnomaliesListElement.appendChild(li);
                });
            } else {
                lotteryAnomaliesContainerElement.classList.add('hidden');
            }
            
            // Detailed Win Stats Table (based on filtered data)
            const winTypeStats = {};
            [...new Set(filteredEvents.map(e => e.winTypeDisplay))].forEach(name => {
                winTypeStats[name] = { name: name, count: 0, totalPayout: 0 };
            });

            filteredEvents.forEach(event => {
                const typeName = event.winTypeDisplay;
                winTypeStats[typeName].count++;
                winTypeStats[typeName].totalPayout += event.goldWon;
            });

            detailedLotteryStats = Object.values(winTypeStats).map(stats => {
                stats.avgPayout = stats.count > 0 ? (stats.totalPayout / stats.count) : 0;
                stats.percentOfTickets = totalTickets > 0 ? (stats.count / totalTickets) * 100 : 0;
                return stats;
            });

            sortAggregatedData(detailedLotteryStats, currentSortStateLotteryStats.column, currentSortStateLotteryStats.direction);
            renderDetailedStatsTable();
            updateSortIndicators('lottery-stats');

            // Main Aggregated Table remains UNFILTERED
            aggregatedLotteryData = aggregateLotteryTransactions(allLotteryEvents); 
            sortAggregatedData(aggregatedLotteryData, currentSortStateLottery.column, currentSortStateLottery.direction);
            renderLotteryTable(); 
            updateSortIndicators('lottery');
            if(noLotteryResultsMessageElement) noLotteryResultsMessageElement.classList.toggle('hidden', aggregatedLotteryData.length > 0);

            // Defer chart rendering to ensure the DOM has calculated the container dimensions
            setTimeout(() => {
                // Pie Chart (based on filtered data)
                const pieChartData = detailedLotteryStats
                    .filter(stats => stats.count > 0) 
                    .map((stats, index) => ({
                        name: stats.name,
                        value: stats.count,
                        color: LOTTERY_CHART_COLORS[index % LOTTERY_CHART_COLORS.length]
                    }));
                renderPieChart(pieChartData, '#lotteryWinTypePieChart');

                // Hourly Chart (based on filtered data)
                const hourlyData = {};
                filteredEvents.forEach(event => {
                    if(!event.timestamp || !(event.timestamp instanceof Date) || isNaN(event.timestamp)) return; 
                    const hour = event.timestamp.getUTCHours(); // Use UTC hours for consistency
                    if (!hourlyData[hour]) {
                        hourlyData[hour] = { hourLabel: `${hour.toString().padStart(2, '0')}:00`, tickets: 0, goldOut: 0, goldIn: 0, net: 0 };
                    }
                    hourlyData[hour].tickets++;
                    hourlyData[hour].goldOut += event.goldWon;
                    hourlyData[hour].goldIn += TICKET_PRICE;
                });
                Object.values(hourlyData).forEach(hourEntry => {
                    hourEntry.net = hourEntry.goldOut - hourEntry.goldIn;
                });

                const hourlyChartData = Array.from({length: 24}, (_, i) => hourlyData[i] || { hourLabel: `${i.toString().padStart(2, '0')}:00`, tickets: 0, goldOut: 0, goldIn: 0, net: 0 });
                renderLineChart(hourlyChartData, '#lotteryHourlyChart');
            }, 10);
        }

        function renderPieChart(data, selector) {
            const containerSelection = d3.select(selector);
            containerSelection.selectAll("*").remove();
            const containerNode = containerSelection.node();
            if (!containerNode) return;

            const margin = {top: 20, right: 80, bottom: 20, left: 80};
            const totalWidth = containerNode.getBoundingClientRect().width;
            const totalHeight = 340;

            if (data.length === 0 || totalWidth <= 160) { // Check if width is too small for labels
                containerSelection.append("div")
                    .style("display", "flex").style("justify-content", "center")
                    .style("align-items", "center").style("height", "100%")
                    .style("color", "#6b7280").style("font-size", "14px")
                    .text("No data to display");
                return;
            }

            const innerWidth = totalWidth - margin.left - margin.right;
            const innerHeight = totalHeight - margin.top - margin.bottom;
            const radius = Math.min(innerWidth, innerHeight) / 2;

            const svg = containerSelection
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr('viewBox', `0 0 ${totalWidth} ${totalHeight}`)
                .append("g")
                .attr("transform", `translate(${totalWidth / 2}, ${totalHeight / 2})`);

            const pie = d3.pie().sort(null).value(d => d.value);
            const data_ready = pie(data);

            const arc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius);
            const outerArcForLabels = d3.arc().innerRadius(radius * 1.05).outerRadius(radius * 1.05);

            svg.selectAll('allSlices')
                .data(data_ready)
                .join('path')
                .attr('d', arc)
                .attr('fill', d => d.data.color)
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .style("opacity", 0.8);

            const labelData = data_ready.map(d => {
                const [x, y] = outerArcForLabels.centroid(d);
                return {
                    x, y,
                    name: `${d.data.name} (${((d.endAngle - d.startAngle) / (2 * Math.PI) * 100).toFixed(1)}%)`,
                    isRight: (d.startAngle + d.endAngle) / 2 < Math.PI,
                    arc: d
                };
            });

            const labelSpacing = 16; 
            labelData.sort((a, b) => a.y - b.y);
            for (let i = 1; i < labelData.length; i++) {
                if (labelData[i].y - labelData[i - 1].y < labelSpacing) {
                    labelData[i].y = labelData[i - 1].y + labelSpacing;
                }
            }

            svg.selectAll('allPolylines')
                .data(labelData)
                .join('polyline')
                .attr("stroke", "black")
                .style("fill", "none")
                .attr("stroke-width", 1)
                .attr('points', function(d) {
                    const [arcX, arcY] = arc.centroid(d.arc);
                    const [outerArcX, ] = outerArcForLabels.centroid(d.arc);
                    const lineEndX = outerArcX + (d.isRight ? 20 : -20);
                    return [[arcX, arcY], [outerArcX, d.y], [lineEndX, d.y]];
                });

            svg.selectAll('allLabels')
                .data(labelData)
                .join('text')
                .text(d => d.name)
                .attr('transform', function(d) {
                    const [outerArcX, ] = outerArcForLabels.centroid(d.arc);
                    const xPos = outerArcX + (d.isRight ? 25 : -25);
                    return `translate(${xPos}, ${d.y})`;
                })
                .style('text-anchor', d => d.isRight ? 'start' : 'end')
                .style("font-size", 12)
                .attr("dy", ".35em");
        }

        function renderLineChart(data, selector) {
            const containerSelection = d3.select(selector);
            containerSelection.selectAll("*").remove();
            const containerNode = containerSelection.node();
            if (!containerNode) return;

            const margin = {top: 20, right: 30, bottom: 50, left: 60};
            const containerWidth = containerNode.getBoundingClientRect().width;
            const width = containerWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            if (!data || data.length === 0 || data.every(d => d.tickets === 0) || width <= 0) {
                 containerSelection.append("div")
                    .style("display", "flex").style("justify-content", "center")
                    .style("align-items", "center").style("height", "100%")
                    .style("color", "#6b7280").style("font-size", "14px")
                    .text("No activity to display");
                 return;
            }

            const svg = containerSelection
                .append("svg")
                .attr("width", "100%")
                .attr("height", height + margin.top + margin.bottom)
                .attr('viewBox', `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.hourLabel))
                .padding(0.2);
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");

            const yValues = data.flatMap(d => [d.goldIn, d.goldOut, d.net]);
            const yMin = d3.min(yValues);
            const yMax = d3.max(yValues);

            const y = d3.scaleLinear()
                .domain([yMin, yMax].map(val => val === undefined ? 0 : val)) 
                .range([height, 0]);
            svg.append("g").call(d3.axisLeft(y));

            svg.append("path").datum(data).attr("fill", "none").attr("stroke", "#82ca9d").attr("stroke-width", 1.5)
                .attr("d", d3.line().x(d => x(d.hourLabel) + x.bandwidth()/2).y(d => y(d.goldIn)));
            svg.append("path").datum(data).attr("fill", "none").attr("stroke", "#8884d8").attr("stroke-width", 1.5)
                .attr("d", d3.line().x(d => x(d.hourLabel) + x.bandwidth()/2).y(d => y(d.goldOut)));
            svg.append("path").datum(data).attr("fill", "none").attr("stroke", "#ff7300").attr("stroke-width", 1.5)
                .attr("d", d3.line().x(d => x(d.hourLabel) + x.bandwidth()/2).y(d => y(d.net)));
            
            const legend = svg.append("g").attr("font-family", "sans-serif").attr("font-size", 10).attr("text-anchor", "end").selectAll("g")
                .data([ {name: "Gold In", color: "#82ca9d"}, {name: "Gold Out", color: "#8884d8"}, {name: "Net Impact", color: "#ff7300"} ])
                .join("g").attr("transform", (d, i) => `translate(0,${i * 20})`);
            legend.append("rect").attr("x", width - 19).attr("width", 19).attr("height", 19).attr("fill", d => d.color);
            legend.append("text").attr("x", width - 24).attr("y", 9.5).attr("dy", "0.32em").text(d => d.name);
        }


        function aggregateTransactions(transactions, includeOrderFillAmountInAggregation) {
            const aggregationMap = new Map();
            transactions.forEach(tx => {
                const key = `${tx.sender}-${tx.receiver}-${tx.itemName}`; 
                if (aggregationMap.has(key)) {
                    const existing = aggregationMap.get(key);
                    existing.times++;
                    existing.totalQuantity += tx.quantity;
                    existing.totalPrice += tx.price; 
                    if (includeOrderFillAmountInAggregation && tx.orderFillAmount !== null) {
                        existing.orderFillAmount = (existing.orderFillAmount || 0) + tx.orderFillAmount;
                    }
                } else {
                    aggregationMap.set(key, {
                        logType: tx.logType, 
                        displayLogType: tx.displayLogType, 
                        sender: tx.sender, 
                        receiver: tx.receiver, 
                        itemName: tx.itemName,
                        times: 1, 
                        totalQuantity: tx.quantity, 
                        orderFillAmount: tx.orderFillAmount, 
                        totalPrice: tx.price, 
                    });
                }
            });
            return Array.from(aggregationMap.values());
        }

        function aggregateLotteryTransactions(transactions) {
            const aggregationMap = new Map();
            transactions.forEach(tx => {
                // Key now includes anomaly status to create separate groups
                const key = `${tx.playerName}-${tx.winTypeDisplay}-${tx.isAnomaly}`; 
                if (aggregationMap.has(key)) {
                    const existing = aggregationMap.get(key);
                    existing.ticketsRolled++;
                    existing.totalGoldWon += tx.goldWon;
                } else {
                    aggregationMap.set(key, {
                        playerName: tx.playerName,
                        winTypeDisplay: tx.winTypeDisplay,
                        rawWinType: tx.rawWinType,
                        ticketsRolled: 1,
                        totalGoldWon: tx.goldWon,
                        isAnomaly: tx.isAnomaly,
                    });
                }
            });
            return Array.from(aggregationMap.values());
        }
        
        function sortAggregatedData(dataArray, column, direction) {
            const getLotterySortKey = (item) => {
                const isAnomaly = typeof item.isAnomaly !== 'undefined' ? item.isAnomaly : item.name.includes('Anomaly');
                const displayName = item.winTypeDisplay || item.name;

                if (isAnomaly) {
                    const typeMatch = displayName.match(/\(Type (\d+)\)/);
                    if (typeMatch) {
                        return { group: 1, base: 100, secondary: parseInt(typeMatch[1], 10) };
                    }
                    const nameMatch = displayName.match(/\((.+)\)/);
                    if (nameMatch) {
                        const name = nameMatch[1];
                        return { group: 1, base: lotteryWinTypeSortOrder[name] || 99, secondary: 0 };
                    }
                    return { group: 1, base: Infinity, secondary: 0 }; 
                } else {
                    return { group: 2, base: lotteryWinTypeSortOrder[displayName] || 99, secondary: 0 };
                }
            };

            dataArray.sort((a, b) => {
                if (column === 'winTypeDisplay' || column === 'name') {
                    const keyA = getLotterySortKey(a);
                    const keyB = getLotterySortKey(b);

                    let comparison = keyA.group - keyB.group;
                    if (comparison === 0) {
                        comparison = keyA.base - keyB.base;
                    }
                    if (comparison === 0) {
                        comparison = keyA.secondary - keyB.secondary;
                    }
                    
                    return direction === 'desc' ? comparison : -comparison;
                }
                
                // --- Existing generic sorting logic ---
                let valA = a[column];
                let valB = b[column]; 
                 if (column === 'displayLogType') {
                    valA = a.displayLogType;
                    valB = b.displayLogType;
                }

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (column === 'orderFillAmount') { 
                    if (valA === null && valB !== null) return direction === 'asc' ? -1 : 1;
                    if (valA !== null && valB === null) return direction === 'asc' ? 1 : -1;
                    if (valA === null && valB === null) return 0;
                }
                 if (column === 'isAnomaly') {
                    if (a.isAnomaly === b.isAnomaly) return 0;
                    const comparisonVal = a.isAnomaly ? -1 : 1;
                    return direction === 'desc' ? comparisonVal : -comparisonVal;
                }

                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                
                return direction === 'asc' ? comparison : comparison * -1;
            });
        }

        function handleSortRequest(column, tableType) {
            let currentSortStateRef;
            let dataToRender;
            let renderFunction;
            
            if (tableType === 'mail') {
                currentSortStateRef = currentSortStateMail;
                dataToRender = aggregatedMailData;
                renderFunction = renderMailTransactionsTable;
            } else if (tableType === 'broker') {
                currentSortStateRef = currentSortStateBroker;
                dataToRender = aggregatedBrokerData;
                renderFunction = renderBrokerTransactionsTable;
            } else if (tableType === 'lottery') {
                currentSortStateRef = currentSortStateLottery;
                dataToRender = aggregatedLotteryData; 
                renderFunction = renderLotteryTable; 
            } else if (tableType === 'lottery-stats') {
                currentSortStateRef = currentSortStateLotteryStats;
                dataToRender = detailedLotteryStats;
                renderFunction = renderDetailedStatsTable;
            } else {
                return; 
            }

            if (currentSortStateRef.column === column) {
                currentSortStateRef.direction = currentSortStateRef.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortStateRef.column = column;
                const descDefaults = ['times', 'totalQuantity', 'totalPrice', 'orderFillAmount', 'ticketsRolled', 'totalGoldWon', 'winTypeDisplay', 'name', 'count', 'totalPayout', 'avgPayout', 'percentOfTickets'];
                if (descDefaults.includes(column)) { 
                    currentSortStateRef.direction = 'desc';
                } else {
                    currentSortStateRef.direction = 'asc'; 
                }
            }
            sortAggregatedData(dataToRender, currentSortStateRef.column, currentSortStateRef.direction);
            renderFunction();
            updateSortIndicators(tableType);
        }

        function updateSortIndicators(tableType) {
            let theadElement;
            let currentSortStateRef;

            if (tableType === 'mail' && mailTransactionsTableTheadElement) {
                theadElement = mailTransactionsTableTheadElement;
                currentSortStateRef = currentSortStateMail;
            } else if (tableType === 'broker' && brokerTransactionsTableTheadElement) {
                theadElement = brokerTransactionsTableTheadElement;
                currentSortStateRef = currentSortStateBroker;
            } else if (tableType === 'lottery' && lotteryResultsTableTheadElement) {
                theadElement = lotteryResultsTableTheadElement; 
                currentSortStateRef = currentSortStateLottery;
            } else if (tableType === 'lottery-stats' && lotteryDetailedStatsTableHeadElement) {
                theadElement = lotteryDetailedStatsTableHeadElement;
                currentSortStateRef = currentSortStateLotteryStats;
            } else {
                return;
            }
            
            if (!theadElement) return; 

            theadElement.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                if (indicator && header.dataset.sortBy === currentSortStateRef.column ) { 
                     indicator.textContent = currentSortStateRef.direction === 'asc' ? 'â–²' : 'â–¼';
                }
                else if (indicator) { 
                    indicator.textContent = ''; 
                }
            });
        }

        function renderMailTransactionsTable() {
            if (!mailTransactionsTableBodyElement) return;
            mailTransactionsTableBodyElement.innerHTML = ""; 
            aggregatedMailData.forEach(tx => {
                const row = mailTransactionsTableBodyElement.insertRow();
                let cell;

                cell = row.insertCell(); cell.textContent = tx.displayLogType; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.sender; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.receiver; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.times; cell.className = 'py-3 px-4 text-center';
                cell = row.insertCell(); cell.textContent = tx.itemName; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.totalQuantity.toLocaleString(); cell.className = 'py-3 px-4 text-right';
                cell = row.insertCell(); cell.textContent = tx.totalPrice.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 }); cell.className = 'py-3 px-4 text-right';
            });
        }


        function renderBrokerTransactionsTable() {
            if (!brokerTransactionsTableBodyElement) return;
            brokerTransactionsTableBodyElement.innerHTML = ""; 
            aggregatedBrokerData.forEach(tx => {
                const row = brokerTransactionsTableBodyElement.insertRow();
                let cell;
                
                cell = row.insertCell(); cell.textContent = tx.displayLogType; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.sender; cell.className = 'py-3 px-4 text-left';
                
                const receiverCell = row.insertCell();
                if (tx.logType === 'BrokerSellItem' || tx.logType === 'BrokerCancelSell' || tx.logType === 'BrokerNewBuyOrder' || tx.logType === 'BrokerCancelOrder' ) { 
                    receiverCell.textContent = ""; 
                } else {
                    receiverCell.textContent = tx.receiver;
                }
                receiverCell.className = 'py-3 px-4 text-left';
                
                cell = row.insertCell(); cell.textContent = tx.times; cell.className = 'py-3 px-4 text-center';
                cell = row.insertCell(); cell.textContent = tx.itemName; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = tx.totalQuantity.toLocaleString(); cell.className = 'py-3 px-4 text-right'; 

                cell = row.insertCell(); 
                cell.textContent = tx.orderFillAmount !== null ? tx.orderFillAmount.toLocaleString() : "";
                cell.className = 'py-3 px-4 text-right';
                cell.classList.toggle('hidden', !showOrderFillAmountColumnGlobal); 
                
                cell = row.insertCell();
                cell.textContent = tx.totalPrice.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 });
                cell.className = 'py-3 px-4 text-right'; 
            });
        }

        function renderLotteryTable() { 
            if (!lotteryResultsTableBodyElement) return;
            lotteryResultsTableBodyElement.innerHTML = "";
            aggregatedLotteryData.forEach(entry => {
                const row = lotteryResultsTableBodyElement.insertRow();
                let cell;

                cell = row.insertCell(); cell.textContent = entry.playerName; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = entry.winTypeDisplay; cell.className = 'py-3 px-4 text-left';
                cell = row.insertCell(); cell.textContent = entry.ticketsRolled.toLocaleString(); cell.className = 'py-3 px-4 text-right';
                cell = row.insertCell(); cell.textContent = entry.totalGoldWon.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }); cell.className = 'py-3 px-4 text-right'; 
                cell = row.insertCell(); 
                cell.textContent = entry.isAnomaly ? "Yes" : "No"; 
                cell.className = 'py-3 px-4 text-center';
                if(entry.isAnomaly) cell.classList.add('anomaly-yes');
            });
        }

        function renderDetailedStatsTable() {
            if (!lotteryDetailedStatsTableBodyElement) return;
            lotteryDetailedStatsTableBodyElement.innerHTML = "";
            detailedLotteryStats.forEach(stats => {
                const row = lotteryDetailedStatsTableBodyElement.insertRow();
                row.insertCell().textContent = stats.name;
                row.insertCell().textContent = stats.count.toLocaleString();
                row.cells[1].className = 'text-right px-6 py-4 whitespace-nowrap';
                row.insertCell().textContent = stats.totalPayout.toLocaleString();
                row.cells[2].className = 'text-right px-6 py-4 whitespace-nowrap';
                row.insertCell().textContent = stats.avgPayout.toFixed(2);
                row.cells[3].className = 'text-right px-6 py-4 whitespace-nowrap';
                row.insertCell().textContent = stats.percentOfTickets.toFixed(2) + '%';
                row.cells[4].className = 'text-right px-6 py-4 whitespace-nowrap';
            });
        }
        
        function renderSkippedLogs() {
            if (!skippedLogsList) return;
            skippedLogsList.innerHTML = '';
            skippedLogs.forEach(line => {
                const li = document.createElement('li');
                li.textContent = line;
                skippedLogsList.appendChild(li);
            });
        }


        function displaySummary(type) {
            const n = parseInt(topNValueElement.value, 10) || 5;
            let dataToDisplay = [];
            let title = "";
            let primaryColumnName = "Name"; 
            let valueColumnName = "Total Quantity (Individual Stats)"; 
            summaryTableNameElement.dataset.activeType = type; 

            switch (type) {
                case 'topSenders':
                    title = `Top ${n} Senders`; 
                    primaryColumnName = currentOverallSenderHeader; 
                    dataToDisplay = Object.values(senderStats).sort((a,b) => b.totalPrice - a.totalPrice).slice(0,n); 
                    valueColumnName = "Total Price";
                    break;
                case 'lowestSenders':
                    title = `Lowest ${n} Senders`; 
                    primaryColumnName = currentOverallSenderHeader; 
                    dataToDisplay = Object.values(senderStats).sort((a,b) => a.totalPrice - b.totalPrice).slice(0,n); 
                    valueColumnName = "Total Price";
                    break;
                case 'topReceivers':
                    title = `Top ${n} Receivers`; 
                    primaryColumnName = currentOverallReceiverHeader; 
                    dataToDisplay = Object.values(receiverStats)
                                     .filter(r => !r.displayName.startsWith('broker_'))
                                     .sort((a,b) => b.totalPrice - a.totalPrice).slice(0,n); 
                    valueColumnName = "Total Price";
                    break;
                case 'lowestReceivers':
                    title = `Lowest ${n} Receivers`; 
                    primaryColumnName = currentOverallReceiverHeader; 
                     dataToDisplay = Object.values(receiverStats)
                                     .filter(r => !r.displayName.startsWith('broker_'))
                                     .sort((a,b) => a.totalPrice - b.totalPrice).slice(0,n); 
                    valueColumnName = "Total Price";
                    break;
                default: summaryTableContainerElement.classList.add('hidden'); return;
            }
            summaryTableNameElement.textContent = title;
            renderSummaryTable(dataToDisplay, primaryColumnName, valueColumnName); 
            summaryTableContainerElement.classList.remove('hidden');
        }
        
        function renderSummaryTable(data, primaryColName, valueColName) {
            summaryTableHeadElement.innerHTML = ""; 
            summaryTableBodyElement.innerHTML = ""; 
            if (data.length === 0) {
                noSummaryDataMessageElement.classList.remove('hidden');
                summaryTableElement.classList.add('hidden'); return;
            }
            summaryTableElement.classList.remove('hidden');
            noSummaryDataMessageElement.classList.add('hidden');
            const headerRow = summaryTableHeadElement.insertRow();
            let th1 = headerRow.insertCell();
            th1.textContent = primaryColName;
            th1.className = "py-3 px-4 border-b border-gray-200 text-left text-sm font-semibold text-gray-600"; 
            let th2 = headerRow.insertCell();
            th2.textContent = valueColName; 
            th2.className = "py-3 px-4 border-b border-gray-200 text-right text-sm font-semibold text-gray-600"; 
            
            data.forEach(item => {
                const row = summaryTableBodyElement.insertRow();
                row.insertCell().textContent = item.displayName; 
                const valueCell = row.insertCell();
                if (valueColName === "Total Price") {
                    valueCell.textContent = item.totalPrice.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 });
                } else { 
                    valueCell.textContent = item.totalQuantity.toLocaleString();
                }
                valueCell.classList.add('text-right');
            });
        }

        function getTopNStatsForPrompt(statsObject, n, type) {
            const filteredStats = Object.values(statsObject).filter(s => 
                !s.displayName.startsWith("broker_") 
            );

            const sorted = filteredStats
                .sort((a, b) => b.totalPrice - a.totalPrice) 
                .slice(0, n);

            if (sorted.length === 0) return `No significant ${type} data involving direct users.`;
            return sorted.map(s => {
                let role = type; 
                if (type === 'sender') role = currentOverallSenderHeader; 
                if (type === 'receiver') role = currentOverallReceiverHeader; 
                return `${s.displayName} (${role} - Qty: ${s.totalQuantity.toLocaleString()}, Price: ${s.totalPrice.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 4})}, Txns: ${s.count})`;
            }).join('; ');
        }

        async function handleGenerateAISummary() {
            const mailBrokerDataForAI = allMailBrokerTransactions; 
            if (mailBrokerDataForAI.length === 0) {
                aiSummaryErrorElement.textContent = "No Mail/Broker transaction data to summarize. Process Mail/Broker logs first.";
                aiSummaryAreaElement.classList.remove('hidden');
                aiSummaryErrorElement.classList.remove('hidden');
                aiSummaryContentElement.classList.add('hidden');
                aiSummaryLoadingElement.classList.add('hidden');
                return;
            }
            aiSummaryAreaElement.classList.remove('hidden');
            aiSummaryContentElement.textContent = ""; 
            aiSummaryContentElement.classList.add('hidden');
            aiSummaryLoadingElement.classList.remove('hidden');
            aiSummaryErrorElement.classList.add('hidden');
            aiSummaryErrorElement.textContent = ""; 
            if(mailBrokerChatContainerElement) mailBrokerChatContainerElement.classList.remove('hidden'); 
            if(aiChatDisplayMailBrokerElement) aiChatDisplayMailBrokerElement.innerHTML = ''; 
            mailBrokerChatHistory = []; 


            const totalMailBrokerTransactions = mailBrokerDataForAI.length; 
            
            const uniqueSendersCount = Object.keys(senderStats).length;
            const uniqueReceiversCount = Object.keys(receiverStats).length;
            const topSendersStr = getTopNStatsForPrompt(senderStats, 3, "sender");
            const topReceiversStr = getTopNStatsForPrompt(receiverStats, 3, "receiver");

            const itemCounts = mailBrokerDataForAI
                .filter(tx => tx.itemName) 
                .reduce((acc, tx) => {
                    acc[tx.itemName] = (acc[tx.itemName] || 0) + tx.quantity;
                    return acc;
                }, {});
            const mostCommonItemsStr = Object.entries(itemCounts)
                .sort((a, b) => b[1] - a[1]).slice(0, 3)
                .map(([name, quantity]) => `${name} (Total Qty: ${quantity.toLocaleString()})`).join('; ') || "N/A";
            
            const logTypeCounts = mailBrokerDataForAI.reduce((acc, tx) => {
                const displayType = tx.displayLogType; 
                acc[displayType] = (acc[displayType] || 0) + 1;
                return acc;
            }, {});
            const logTypeCountsStr = Object.entries(logTypeCounts)
                .map(([type, count]) => `${type}: ${count}`)
                .join(', ');


            const initialPrompt = `
Analyze the mail and broker transaction log summary. Provide a brief, insightful narrative.
The logs include:
- 'Mail': Direct mail transactions. Price is from C field.
- 'BuyItem': Broker item purchases. Price is from C field.
- 'SellItem': Items listed for sale on broker. Price is from C field (total value for Q items).
- 'CancelSell': Cancelled sell listings. Price is from C field (total value for Q items).
- 'FillBuyOrder': Buy orders fulfilled by sellers. Price is (Amount_field_value * C_field_price_per_item). 'Quantity' column shows original order Q, 'Amount' column (broker specific) shows Amount_field_value.
- 'NewBuyOrder': New buy orders placed. Price is from C field (total value for Q items). 'Quantity' column shows Q_field, 'Amount' column (broker specific) shows Amount_field_value.
- 'CancelOrder': Cancelled buy orders. Price is from C field (total value for Q items).
The 'Type' column in tables indicates these cleaned types. The table headers for individual stats summary are '${currentOverallSenderHeader}' and '${currentOverallReceiverHeader}'. Mail table uses Sender/Receiver, Broker table uses Seller/Buyer.
Note: 'Price' values for Mail/Broker logs shown (in tables and summaries) have been divided by 10,000 from their original raw log values. The 'Amount' column in the broker table is specific to NewBuyOrder and FillBuyOrder.

Data (Mail & Broker logs, names are case-insensitive for stats):
- Total Mail/Broker Transactions Parsed: ${totalMailBrokerTransactions}
- Breakdown by Mail/Broker Transaction Type: ${logTypeCountsStr}
- Unique ${currentOverallSenderHeader} (Mail/Broker): ${uniqueSendersCount}
- Unique ${currentOverallReceiverHeader} (Mail/Broker): ${uniqueReceiversCount}
- Top 3 ${currentOverallSenderHeader} (players, by total price, Mail/Broker): ${topSendersStr}
- Top 3 ${currentOverallReceiverHeader} (players, by total price, Mail/Broker): ${topReceiversStr}
- Top 3 Items (by total quantity transacted/listed, Mail/Broker): ${mostCommonItemsStr}

Key takeaways regarding mail vs. various broker activities, prominent traders, or item flows? What do the different broker actions indicate about market behavior (e.g., items frequently listed vs. items frequently bought directly)?`;
            
            mailBrokerChatHistory.push({role: "user", parts: [{text: "Provide an initial summary based on this data: " + initialPrompt}]});

            try {
                const payload = { contents: mailBrokerChatHistory }; 
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    aiSummaryContentElement.textContent = aiResponse;
                    aiSummaryContentElement.classList.remove('hidden');
                    mailBrokerChatHistory.push({role: "model", parts: [{text: aiResponse}]}); 
                } else {
                    throw new Error("Unexpected API response structure.");
                }
            } catch (error) { 
                console.error('AI summary error:', error);
                aiSummaryErrorElement.textContent = `AI summary error: ${error.message}. See console.`;
                aiSummaryErrorElement.classList.add('hidden');
                aiSummaryContentElement.classList.add('hidden');
            } 
            finally {
                aiSummaryLoadingElement.classList.add('hidden');
            }
        }

        async function handleGenerateLotteryNarrative() {
            if (!hasLotteryLogsGlobal || allLotteryEvents.length === 0) {
                aiLotteryNarrativeErrorElement.textContent = "No Lottery data to summarize. Process Lottery logs first.";
                aiLotteryNarrativeAreaElement.classList.remove('hidden');
                aiLotteryNarrativeErrorElement.classList.remove('hidden');
                aiLotteryNarrativeContentElement.classList.add('hidden');
                aiLotteryNarrativeLoadingElement.classList.add('hidden');
                return;
            }
            aiLotteryNarrativeAreaElement.classList.remove('hidden');
            aiLotteryNarrativeContentElement.textContent = "";
            aiLotteryNarrativeContentElement.classList.add('hidden');
            aiLotteryNarrativeLoadingElement.classList.remove('hidden');
            aiLotteryNarrativeErrorElement.classList.add('hidden');
            aiLotteryNarrativeErrorElement.textContent = "";
            lotteryChatContainerElement.classList.remove('hidden'); 
            if(aiChatDisplayLotteryElement) aiChatDisplayLotteryElement.innerHTML = ''; 
            lotteryChatHistory = []; 


            const totalTickets = allLotteryEvents.length;
            const totalGoldSpent = totalTickets * TICKET_PRICE; 
            const totalGoldWon = allLotteryEvents.reduce((sum, event) => sum + event.goldWon, 0);
            const netGoldChange = totalGoldWon - totalGoldSpent;
            const overallWinRate = totalTickets > 0 ? (allLotteryEvents.filter(e => e.winTypeDisplay !== 'NoWin' && !e.isAnomaly).length / totalTickets) * 100 : 0;
            const rtp = totalGoldSpent > 0 ? (totalGoldWon / totalGoldSpent) * 100 : 0; 
            const anomalies = allLotteryEvents.filter(e => e.isAnomaly);

            const winTypeCounts = {};
            const EXPECTED_WIN_RANGES_KEYS = Object.keys(EXPECTED_WIN_RANGES); 
            EXPECTED_WIN_RANGES_KEYS.forEach(type => { 
                 winTypeCounts[EXPECTED_WIN_RANGES[type].name] = 0;
            });
            allLotteryEvents.forEach(event => {
                const typeName = mapWinTypeToDisplay(event.rawWinType);
                winTypeCounts[typeName] = (winTypeCounts[typeName] || 0) + 1;
            });
            const winTypeDistributionStr = Object.entries(winTypeCounts).map(([type, count]) => `${type}: ${count}`).join(', ');
            
            let hourlySummary = "";
            const hourlyData = {};
            allLotteryEvents.forEach(event => {
                if(!event.timestamp || !(event.timestamp instanceof Date) || isNaN(event.timestamp)) return; 
                const hour = event.timestamp.getHours();
                hourlyData[hour] = (hourlyData[hour] || 0) + 1;
            });
            if (Object.keys(hourlyData).length > 0) {
                const peakHour = Object.keys(hourlyData).reduce((a,b) => hourlyData[a] > hourlyData[b] ? a : b);
                hourlySummary = `Lottery activity peaks around ${peakHour.padStart(2,'0')}:00. `;
            }


            const initialPrompt = `
Analyze the following lottery system data and provide a concise narrative summary.
Focus on overall economic impact (gold generation/sink), win rates, Return To Player (RTP), common win types, any detected anomalies, and hourly trends if apparent.
Ticket Price: ${TICKET_PRICE} gold.
Expected Win Types: Jackpot, GrandPrize, BigWin, Win, NoWin.

Lottery Metrics:
- Total Tickets Used: ${totalTickets.toLocaleString()}
- Total Gold Spent: ${totalGoldSpent.toLocaleString()} gold
- Total Gold Won (Payouts): ${totalGoldWon.toLocaleString()} gold
- Net Gold Impact (Won - Spent): ${netGoldChange.toLocaleString()} gold
- Overall Win Rate (excluding anomalies): ${overallWinRate.toFixed(2)}%
- Return To Player (RTP): ${rtp.toFixed(2)}%
- Win Type Distribution (counts): ${winTypeDistributionStr}
- Anomalous Entries Detected: ${anomalies.length}
- Hourly Activity Summary: ${hourlySummary || "Not enough data for hourly trends."}

Based on these metrics, what are the key observations and trends? Is the lottery inflationary or deflationary? Are there any significant anomalies to highlight?`;
            
            lotteryChatHistory.push({role: "user", parts: [{text: "Provide an initial summary based on this data: " + initialPrompt}]});

            try {
                const payload = { contents: lotteryChatHistory }; 
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    aiLotteryNarrativeContentElement.textContent = aiResponse;
                    aiLotteryNarrativeContentElement.classList.remove('hidden');
                    lotteryChatHistory.push({role: "model", parts: [{text: aiResponse}]});
                } else {
                    throw new Error("Unexpected API response structure for lottery narrative.");
                }
            } catch (error) { 
                console.error('AI Lottery Narrative error:', error);
                aiLotteryNarrativeErrorElement.textContent = `AI Lottery Narrative error: ${error.message}. See console.`;
                aiLotteryNarrativeErrorElement.classList.add('hidden');
                aiLotteryNarrativeContentElement.classList.add('hidden');
            } 
            finally {
                aiLotteryNarrativeLoadingElement.classList.add('hidden');
            }
        }

        async function handleMailBrokerChatQuery() {
            const query = aiChatInputMailBrokerElement.value.trim();
            if (!query) return;

            appendMessageToChat(query, 'user', 'mailbroker');
            aiChatInputMailBrokerElement.value = '';
            aiChatLoadingMailBrokerElement.classList.remove('hidden');
            
            let contextForQuery = "Follow up question about Mail/Broker data.\n";
            const playerQueryMatch = query.match(/player\s+([\w\s]+)/i) || query.match(/([\w\s]+)\s*details/i) || query.match(/tell me about\s+([\w\s]+)/i);
            if(playerQueryMatch && playerQueryMatch[1]){
                const playerName = playerQueryMatch[1].trim().toLowerCase();
                const SStats = senderStats[playerName];
                const RStats = receiverStats[playerName];
                contextForQuery += `Specific data for player "${playerName}":\n`;
                if(SStats) contextForQuery += `As Sender/Seller: Transactions=${SStats.count}, Total Quantity=${SStats.totalQuantity.toLocaleString()}, Total Price=${SStats.totalPrice.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:4})}.\n`;
                else contextForQuery += `No records as Sender/Seller for ${playerName}.\n`;
                if(RStats) contextForQuery += `As Receiver/Buyer: Transactions=${RStats.count}, Total Quantity=${RStats.totalQuantity.toLocaleString()}, Total Price=${RStats.totalPrice.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:4})}.\n`;
                else contextForQuery += `No records as Receiver/Buyer for ${playerName}.\n`;
            }


            mailBrokerChatHistory.push({role: "user", parts: [{text: contextForQuery + "User question: " + query}]});
            
            const payload = { contents: mailBrokerChatHistory }; 

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    appendMessageToChat(aiResponse, 'ai', 'mailbroker');
                    mailBrokerChatHistory.push({role: "model", parts: [{text: aiResponse}]});
                } else {
                    appendMessageToChat("Sorry, I couldn't get a response. Please try again.", 'ai', 'mailbroker');
                }
            } catch (error) {
                console.error('Mail/Broker Chat AI error:', error);
                appendMessageToChat(`Error: ${error.message}`, 'ai', 'mailbroker');
            } finally {
                aiChatLoadingMailBrokerElement.classList.add('hidden');
            }
        }

        async function handleLotteryChatQuery() {
            const query = aiChatInputLotteryElement.value.trim();
            if (!query) return;

            appendMessageToChat(query, 'user', 'lottery');
            aiChatInputLotteryElement.value = '';
            aiChatLoadingLotteryElement.classList.remove('hidden');

            let contextForQuery = "Follow up question about Lottery data. Here's a summary of the aggregated data already calculated (if any):\n";
            if (aggregatedLotteryData && aggregatedLotteryData.length > 0) {
                aggregatedLotteryData.slice(0,10).forEach(entry => { 
                    contextForQuery += `Player: ${entry.playerName}, Win Type: ${entry.winTypeDisplay}, Tickets Rolled: ${entry.ticketsRolled}, Total Gold Won: ${entry.totalGoldWon}, Anomaly: ${entry.isAnomaly ? 'Yes' : 'No'}\n`;
                });
                 if(aggregatedLotteryData.length > 10) contextForQuery += `...and ${aggregatedLotteryData.length -10} more aggregated player entries.\n`;
            } else if (allLotteryEvents.length > 0) { 
                 contextForQuery += `Raw lottery event data is available for ${allLotteryEvents.length} entries. Ask about specific players to get their summary.\n`;
            }
            else {
                contextForQuery += "No aggregated player data currently available.\n";
            }

            
            const playerQueryMatch = query.match(/player\s+([\w\s]+)/i) || query.match(/([\w\s]+)\s*details/i) || query.match(/tell me about\s+([\w\s]+)/i);
            if(playerQueryMatch && playerQueryMatch[1]){
                const playerName = playerQueryMatch[1].trim().toLowerCase();
                const playerEvents = allLotteryEvents.filter(e => e.playerName.toLowerCase() === playerName);
                 contextForQuery += `\nSpecifically for player "${playerName}":\n`;
                if(playerEvents.length > 0){
                    const totalTicketsByPlayer = playerEvents.length;
                    const totalWonByPlayer = playerEvents.reduce((sum, e) => sum + e.goldWon, 0);
                    const winTypesForPlayerCounts = playerEvents.reduce((acc, e) => {
                        acc[e.winTypeDisplay] = (acc[e.winTypeDisplay] || 0) + 1;
                        return acc;
                    }, {});
                    const winTypesSummary = Object.entries(winTypesForPlayerCounts).map(([type, count]) => `${type}: ${count}`).join(', ');
                    contextForQuery += `Total Tickets Rolled=${totalTicketsByPlayer}, Total Gold Won=${totalWonByPlayer.toLocaleString()}, Win Types Encountered: ${winTypesSummary}.\n`;
                } else {
                    contextForQuery += `No specific data found for player ${playerName} in the lottery logs.\n`;
                }
            }


            lotteryChatHistory.push({role: "user", parts: [{text: contextForQuery + "User question: " + query}]});
            const payload = { contents: lotteryChatHistory };

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                 if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    appendMessageToChat(aiResponse, 'ai-lottery', 'lottery'); 
                    lotteryChatHistory.push({role: "model", parts: [{text: aiResponse}]});
                } else {
                     appendMessageToChat("Sorry, I couldn't get a response. Please try again.", 'ai-lottery', 'lottery');
                }
            } catch (error) {
                console.error('Lottery Chat AI error:', error);
                appendMessageToChat(`Error: ${error.message}`, 'ai-lottery', 'lottery');
            } finally {
                aiChatLoadingLotteryElement.classList.add('hidden');
            }
        }

        function appendMessageToChat(message, sender, chatType) {
            const displayArea = chatType === 'mailbroker' ? aiChatDisplayMailBrokerElement : aiChatDisplayLotteryElement;
            if (!displayArea) return;

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            if (sender === 'user') {
                messageDiv.classList.add('chat-message-user');
            } else if (sender === 'ai') { 
                messageDiv.classList.add('chat-message-ai');
            } else if (sender === 'ai-lottery') { 
                 messageDiv.classList.add('chat-message-ai-lottery');
            }
            
            const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap'; 
            pre.style.wordWrap = 'break-word'; 
            pre.textContent = message;
            messageDiv.appendChild(pre);
            
            displayArea.appendChild(messageDiv);
            displayArea.scrollTop = displayArea.scrollHeight; 
        }

        function handleCopyReport() {
            let tsvContent = "";
            const headers = (keys) => keys.join('\t') + '\n';
            const row = (values) => values.join('\t') + '\n';

            if (lastProcessedLogType === 'mailbroker') {
                 if (!(hasMailLogsGlobal || hasBrokerLogsGlobal)) {
                     alert("No mail or broker data available to create a report.");
                     return;
                 }
                 if (hasMailLogsGlobal) {
                     tsvContent += "Aggregated Mail Transactions\n";
                     tsvContent += headers(["Type", "Sender", "Receiver", "Times", "Item Name", "Quantity", "Price"]);
                     aggregatedMailData.forEach(tx => {
                        tsvContent += row([tx.displayLogType, tx.sender, tx.receiver, tx.times, tx.itemName, tx.totalQuantity, tx.totalPrice]);
                     });
                     tsvContent += "\n\n";
                 }
                 if (hasBrokerLogsGlobal) {
                     tsvContent += "Aggregated Broker Transactions\n";
                     const brokerHeaders = ["Type", "Seller", "Buyer", "Times", "Item Name", "Quantity"];
                     if(showOrderFillAmountColumnGlobal) brokerHeaders.push("Amount");
                     brokerHeaders.push("Price");
                     tsvContent += headers(brokerHeaders);
                     
                     aggregatedBrokerData.forEach(tx => {
                         const rowData = [tx.displayLogType, tx.sender, tx.receiver, tx.times, tx.itemName, tx.totalQuantity];
                         if(showOrderFillAmountColumnGlobal) rowData.push(tx.orderFillAmount !== null ? tx.orderFillAmount : "");
                         rowData.push(tx.totalPrice);
                         tsvContent += row(rowData);
                     });
                 }


            } else if (lastProcessedLogType === 'lottery') {
                if (!hasLotteryLogsGlobal) {
                    alert("No lottery data available to create a report.");
                    return;
                }
                tsvContent += "Lottery Metrics Summary\n";
                const metrics = [
                    ["Total Tickets Used", document.getElementById('lotteryTotalTickets').textContent],
                    ["Total Gold Spent", document.getElementById('lotteryGoldIn').textContent],
                    ["Total Winning Tickets", document.getElementById('lotteryTotalWinningTickets').textContent],
                    ["Total Gold Won", document.getElementById('lotteryGoldOut').textContent],
                    ["Net Gold Impact", document.getElementById('lotteryNetGold').textContent],
                    ["Overall Win Rate", document.getElementById('lotteryWinRate').textContent],
                    ["Return To Player (RTP)", document.getElementById('lotteryRTP').textContent],
                    ["Anomalous Entries", document.getElementById('lotteryAnomalyCount').textContent]
                ];
                metrics.forEach(rowArray => {
                    tsvContent += rowArray.join("\t") + "\n";
                });
                tsvContent += "\n\n";

                tsvContent += "Aggregated Lottery Results (by Player)\n";
                tsvContent += headers(["Player", "Win Type", "Tickets Rolled", "Total Gold Won", "Anomaly"]);
                aggregatedLotteryData.forEach(item => {
                    tsvContent += row([item.playerName, item.winTypeDisplay, item.ticketsRolled, item.totalGoldWon, item.isAnomaly ? 'Yes' : 'No']);
                });
                tsvContent += "\n\n";

                tsvContent += "Detailed Win Statistics (by Win Type)\n";
                tsvContent += headers(["Win Type", "Count", "Total Payout", "Avg Payout", "% of Tickets"]);
                detailedLotteryStats.forEach(stats => {
                     tsvContent += row([stats.name, stats.count, stats.totalPayout, stats.avgPayout.toFixed(2), stats.percentOfTickets.toFixed(2) + '%']);
                });
            } else {
                alert("No data processed yet.");
                return;
            }
            
            // Copy to clipboard
            const textarea = document.createElement('textarea');
            textarea.value = tsvContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // Visual feedback
            const originalText = copyReportButtonElement.textContent;
            copyReportButtonElement.textContent = "Copied!";
            setTimeout(() => {
                copyReportButtonElement.textContent = originalText;
            }, 2000);
        }

        function generateHtmlReport() {
            const reportWindow = window.open("", "_blank");
            if (!reportWindow) {
                alert("Please allow popups for this site to generate reports.");
                return;
            }

            let reportBodyHtml = `<div class="container mx-auto p-4 sm:p-6 md:p-8"><section id="reportArea" class="bg-white p-6 rounded-xl shadow-xl">`;
            
            let headerHtml = `<div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Analysis Report</h2>
                                <div class="flex items-center gap-4">`;
            
            const dateFilterContainerClone = dateFilterContainerElement.cloneNode(true);
            dateFilterContainerClone.classList.remove('hidden');
            
            const originalStartDate = startDateInputElement.value;
            if (originalStartDate) {
                const startDateInputClone = dateFilterContainerClone.querySelector('#startDate');
                startDateInputClone.setAttribute('value', originalStartDate);
            }
            
            const originalEndDate = endDateInputElement.value;
            if (originalEndDate) {
                const endDateInputClone = dateFilterContainerClone.querySelector('#endDate');
                endDateInputClone.setAttribute('value', originalEndDate);
            }

            headerHtml += dateFilterContainerClone.outerHTML;

            headerHtml += `<button id="saveReportBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md text-sm self-end">Save Report</button>
                           </div></div>`;
            
            const activeFilterInfoClone = activeFilterInfoElement.cloneNode(true);
            if(!activeFilterInfoClone.classList.contains('hidden')){
                 headerHtml += activeFilterInfoClone.outerHTML;
            }

            reportBodyHtml += headerHtml;

            if (hasMailLogsGlobal) reportBodyHtml += mailTableContainer.outerHTML;
            if (hasBrokerLogsGlobal) {
                reportBodyHtml += brokerTableContainer.outerHTML;
                if (!summaryControls.classList.contains('hidden')) reportBodyHtml += summaryControls.outerHTML;
                if (!summaryTableContainer.classList.contains('hidden')) reportBodyHtml += summaryTableContainer.outerHTML;
            }
            
            if (hasLotteryLogsGlobal) {
                 const lotterySectionClone = lotteryAnalysisSectionElement.cloneNode(true);
                 // Remove interactive elements not needed in the report
                 lotterySectionClone.querySelector('#lotteryChatContainer')?.remove();
                 if(aiLotteryNarrativeArea.classList.contains('hidden')){
                    lotterySectionClone.querySelector('#aiLotteryNarrativeArea')?.remove();
                 }
                reportBodyHtml += lotterySectionClone.outerHTML;
            }
             if (!aiSummaryArea.classList.contains('hidden')) {
                const aiSummaryClone = aiSummaryArea.cloneNode(true);
                // Remove interactive elements not needed in the report
                aiSummaryClone.querySelector('#mailBrokerChatContainer')?.remove();
                reportBodyHtml += aiSummaryClone.outerHTML;
            }
            
            reportBodyHtml += `</section></div>`;

            const functionsToInject = [
                setupCollapsible, setupDragToResize, sortAggregatedData,
                renderMailTransactionsTable, renderBrokerTransactionsTable, renderLotteryTable,
                renderDetailedStatsTable, renderPieChart, renderLineChart,
                mapWinTypeToDisplay, isValidLotteryWinAmount, aggregateLotteryTransactions,
                updateSortIndicators, handleSortRequest, generateWinTypeFilters, renderLotteryAnalysis
            ];

            let scriptContent = `
                function downloadReport() {
                    const reportClone = document.documentElement.cloneNode(true);
                    const saveBtnInClone = reportClone.querySelector('#saveReportBtn');
                    if (saveBtnInClone) saveBtnInClone.remove();
                    const scriptInClone = reportClone.querySelector('script');
                    if (scriptInClone) scriptInClone.remove();
                    const htmlContent = '<!DOCTYPE html>' + reportClone.outerHTML;
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date().toISOString().slice(0, 10);
                    a.href = url;
                    a.download = \`log-analysis-report-\${date}.html\`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                document.addEventListener('DOMContentLoaded', () => {
                    const initialData = window.initialData;
                    window.allLotteryEvents = initialData.allLotteryEvents;
                    window.aggregatedMailData = initialData.aggregatedMailData;
                    window.aggregatedBrokerData = initialData.aggregatedBrokerData;
                    window.aggregatedLotteryData = initialData.aggregatedLotteryData;
                    window.detailedLotteryStats = initialData.detailedLotteryStats;
                    window.currentSortStateMail = initialData.currentSortStateMail;
                    window.currentSortStateBroker = initialData.currentSortStateBroker;
                    window.currentSortStateLottery = initialData.currentSortStateLottery;
                    window.currentSortStateLotteryStats = initialData.currentSortStateLotteryStats;
                    window.showOrderFillAmountColumnGlobal = initialData.showOrderFillAmountColumnGlobal;
                    window.hasMailLogsGlobal = initialData.hasMailLogsGlobal;
                    window.hasBrokerLogsGlobal = initialData.hasBrokerLogsGlobal;
                    window.hasLotteryLogsGlobal = initialData.hasLotteryLogsGlobal;
                    window.excludedWinTypes = new Set(initialData.excludedWinTypes);
                    window.TICKET_PRICE = initialData.TICKET_PRICE;
                    window.EXPECTED_WIN_RANGES = initialData.EXPECTED_WIN_RANGES;
                    window.LOTTERY_CHART_COLORS = initialData.LOTTERY_CHART_COLORS;
                    window.lotteryWinTypeSortOrder = initialData.lotteryWinTypeSortOrder;
                    
                    window.allLotteryEvents.forEach(ev => { if(ev.timestamp) ev.timestamp = new Date(ev.timestamp); });

                    ${functionsToInject.map(fn => `window.${fn.name} = ${fn.toString()};`).join('\n\n')}
                   
                    window.mailTransactionsTableTheadElement = document.getElementById('mailTransactionsTable')?.getElementsByTagName('thead')[0];
                    window.mailTransactionsTableBodyElement = document.getElementById('mailTransactionsTable')?.getElementsByTagName('tbody')[0];
                    window.brokerTransactionsTableTheadElement = document.getElementById('brokerTransactionsTable')?.getElementsByTagName('thead')[0];
                    window.brokerTransactionsTableBodyElement = document.getElementById('brokerTransactionsTable')?.getElementsByTagName('tbody')[0];
                    window.lotteryResultsTableTheadElement = document.getElementById('lotteryResultsTable')?.getElementsByTagName('thead')[0];
                    window.lotteryResultsTableBodyElement = document.getElementById('lotteryResultsTable')?.getElementsByTagName('tbody')[0];
                    window.lotteryDetailedStatsTableHeadElement = document.getElementById('lotteryDetailedStatsTable')?.getElementsByTagName('thead')[0];
                    window.lotteryDetailedStatsTableBodyElement = document.getElementById('lotteryDetailedStatsTable')?.getElementsByTagName('tbody')[0];
                    window.lotteryWinTypeFiltersElement = document.getElementById('lotteryWinTypeFilters');
                    window.lotteryFilterContainerElement = document.getElementById('lotteryFilterContainer');
                    window.lotteryAnomaliesContainerElement = document.getElementById('lotteryAnomaliesContainer');
                    window.lotteryAnomaliesListElement = document.getElementById('lotteryAnomaliesList');
                    window.anomalyCountElement = document.getElementById('anomalyCount');
                    window.noLotteryResultsMessageElement = document.getElementById('noLotteryResultsMessage');

                    document.body.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));
                    
                    const loadingIds = ['aiSummaryLoading', 'aiChatLoadingMailBroker', 'aiLotteryNarrativeLoading', 'aiChatLoadingLottery'];
                    loadingIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });

                    document.body.querySelectorAll('#reportActions').forEach(el => el.remove());

                    document.getElementById('saveReportBtn').addEventListener('click', downloadReport);
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 's') {
                            e.preventDefault();
                            downloadReport();
                        }
                    });

                    if(hasMailLogsGlobal) { renderMailTransactionsTable(); updateSortIndicators('mail'); }
                    if(hasBrokerLogsGlobal) { renderBrokerTransactionsTable(); updateSortIndicators('broker'); }
                    if(hasLotteryLogsGlobal) { 
                        generateWinTypeFilters(allLotteryEvents);
                        renderLotteryAnalysis(); 
                    }
                    
                    document.querySelectorAll('.sortable-header').forEach(header => {
                        header.addEventListener('click', () => handleSortRequest(header.dataset.sortBy, header.dataset.tableType));
                    });
                     
                    setupCollapsible(document.getElementById('toggleMailTableBtn'), document.getElementById('mailTableContent'));
                    setupCollapsible(document.getElementById('toggleBrokerTableBtn'), document.getElementById('brokerTableContent'));
                    setupCollapsible(document.getElementById('toggleAnomaliesBtn'), document.getElementById('anomaliesContent'));
                    setupCollapsible(document.getElementById('toggleLotteryTableBtn'), document.getElementById('lotteryTableContent'));
                    setupCollapsible(document.getElementById('toggleDetailedStatsBtn'), document.getElementById('detailedStatsContent'));
                    setupCollapsible(document.getElementById('toggleSkippedLogsBtn'), document.getElementById('skippedLogsContent'));
                     
                    if(document.getElementById('mailTableContent')) setupDragToResize(document.getElementById('mailResizeHandle'), document.getElementById('mailTableContent').querySelector('.table-scroll-container'));
                    if(document.getElementById('brokerTableContent')) setupDragToResize(document.getElementById('brokerResizeHandle'), document.getElementById('brokerTableContent').querySelector('.table-scroll-container'));
                    if(document.getElementById('anomaliesContent')) setupDragToResize(document.getElementById('anomaliesResizeHandle'), document.getElementById('anomaliesContent').querySelector('.table-scroll-container'));
                    if(document.getElementById('lotteryTableContent')) setupDragToResize(document.getElementById('lotteryResizeHandle'), document.getElementById('lotteryTableContent').querySelector('.table-scroll-container'));
                    if(document.getElementById('detailedStatsContent')) setupDragToResize(document.getElementById('detailedStatsResizeHandle'), document.getElementById('detailedStatsContent').querySelector('.table-scroll-container'));
                    if(document.getElementById('skippedLogsContent')) setupDragToResize(document.getElementById('skippedLogsResizeHandle'), document.getElementById('skippedLogsContent').querySelector('.table-scroll-container'));
                });
            `;

            let finalHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Interactive Log Analysis Report</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <script src="https://d3js.org/d3.v7.min.js"><\/script>
                    <style>${document.head.querySelector('style').innerHTML}<\/style>
                </head>
                <body class="bg-gray-100">
                    ${reportBodyHtml}
                    <script>${scriptContent}<\/script>
                </body>
                </html>`;
            
            reportWindow.document.write(finalHtml);
            reportWindow.initialData = {
                allLotteryEvents,
                aggregatedMailData,
                aggregatedBrokerData,
                aggregatedLotteryData,
                detailedLotteryStats,
                currentSortStateMail,
                currentSortStateBroker,
                currentSortStateLottery,
                currentSortStateLotteryStats,
                showOrderFillAmountColumnGlobal,
                hasMailLogsGlobal,
                hasBrokerLogsGlobal,
                hasLotteryLogsGlobal,
                excludedWinTypes: Array.from(excludedWinTypes),
                TICKET_PRICE,
                EXPECTED_WIN_RANGES,
                LOTTERY_CHART_COLORS,
                lotteryWinTypeSortOrder
            };
            reportWindow.document.close();
        }

    </script>
</body>
</html>